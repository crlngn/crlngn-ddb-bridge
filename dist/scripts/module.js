var Y=Object.defineProperty;var j=(g,e,t)=>e in g?Y(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var p=(g,e,t)=>j(g,typeof e!="symbol"?e+"":e,t);const f={toHit:{prop:"toHit",cls:"to hit",actionType:"attack",rollType:"attack"},damage:{prop:"damage",cls:"damage",actionType:"damage",rollType:"damage"},heal:{prop:"heal",cls:"heal",actionType:"heal",rollType:"heal"},save:{prop:"save",cls:"save",actionType:"save",rollType:"ability"},check:{prop:"check",cls:"check",actionType:"check",rollType:"ability"},custom:{prop:"custom",cls:"roll",actionType:"roll",rollType:"custom"},cast:{prop:"cast",cls:"cast",actionType:"cast",rollType:"cast"}},V="crlngn-ddb-bridge",_="crlngn-ddb-bridge",v=["%cDDB Gamelog Tweaks","color:rgb(100, 160, 238); font-weight: bold;","|"],z={abilityCheck:"ability",abilitySave:"save",attack:"attack",check:"check",concentration:"concentration",damage:"damage",deathSave:"death",formula:"formula",healing:"heal",custom:"roll",skillCheck:"skill",toolCheck:"tool"},W=[{abbrev:"str",name:"strength"},{abbrev:"dex",name:"dexterity"},{abbrev:"con",name:"constitution"},{abbrev:"int",name:"intelligence"},{abbrev:"wis",name:"wisdom"},{abbrev:"cha",name:"charisma"}],H={CHAT_MESSAGE:"chatMessage",INIT:"init",READY:"ready",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",RENDER_CHAT_MESSAGE:"renderChatMessage",CREATE_MEASURED_TEMPLATE:"createMeasuredTemplate",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CLOSE_SETTINGS_CONFIG:"closeSettingsConfig",RENDER_ROLL_RESOLVER:"renderRollResolver"},y={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_ROLL_ABILITY_TEST:"dnd5e.preRollAbilityTest",PRE_ROLL_ABILITY_SAVE:"dnd5e.preRollAbilitySave",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrow",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_CLASS_HIT_POINTS:"dnd5e.preRollClassHitPoints",PRE_ROLL_CONCENTRATION:"dnd5e.preRollConcentration",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",PRE_ROLL_DEATH_SAVE:"dnd5e.preRollDeathSave",PRE_ROLL_FORMULA_V2:"dnd5e.preRollFormulaV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_NPC_HIT_POINTS:"dnd5e.preRollNPCHitPoints",PRE_ROLL_RECHARGE_V2:"dnd5e.preRollRechargeV2",PRE_ROLL_SKILL:"dnd5e.preRollSkill",PRE_ROLL_TOOL_CHECK:"dnd5e.preRollToolCheck",PRE_USE_ITEM:"dnd5e.preUseItem",ROLL_ABILITY_TEST:"dnd5e.rollAbilityTest",ROLL_ABILITY_SAVE:"dnd5e.rollAbilitySave",ROLL_ATTACK_V2:"dnd5e.rollAttackV2",ROLL_CLASS_HIT_POINTS:"dnd5e.rollClassHitPoints",ROLL_CONCENTRATION:"dnd5e.rollConcentration",ROLL_DEATH_SAVE:"dnd5e.rollDeathSave",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",ROLL_FORMULA_V2:"dnd5e.rollFormulaV2",ROLL_HIT_DIE_V2:"dnd5e.rollHitDieV2",ROLL_INITIATIVE:"dnd5e.rollInitiative",ROLL_NPC_HIT_POINTS:"dnd5e.rollNPCHitPoints",ROLL_RECHARGE_V2:"dnd5e.rollRechargeV2",ROLL_SKILL:"dnd5e.rollSkill",ROLL_TOOL_CHECK:"dnd5e.rollToolCheck",DISPLAY_CARD:"dnd5e.preDisplayCardV2",PRE_DISPLAY_CARD_V2:"dnd5e.preDisplayCardV2",RENDER_CHAT_MESSAGE:"dnd5e.renderChatMessage",PRE_LONG_REST:"dnd5e.preLongRest",PRE_REST_COMPLETED:"dnd5e.preRestCmpleted",PRE_SHORT_REST:"dnd5e.preShortRest",REST_COMPLETED:"dnd5e.restCmpleted",ACTIVITY_CONSUMPTION:"dnd5e.activityConsumption",POST_ACTIVITY_CONSUMPTION:"dnd5e.postActivityConsumption",POST_CREATE_USAGE_MESSAGE:"dnd5e.postCreateUsageMessage",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ACTIVITY_CONSUMPTION:"dnd5e.preActivityConsumption",PRE_CREATE_USAGE_MESSAGE:"dnd5e.preCreateUsageMessage",PRE_USE_ACTIVITY:"dnd5e.preUseActivity"},J={READY:"socketlib.ready"},N={select:"select",checkbox:"checkbox"},w={client:"client",world:"world"};function D(){return{enableChatStyles:{tag:"enable-chat-styles",label:game.i18n.localize("CRLNGN.settings.enableChatStyles.label"),hint:game.i18n.localize("CRLNGN.settings.enableChatStyles.hint"),propType:Boolean,inputType:N.checkbox,default:!0,scope:w.client,config:!0,requiresReload:!0},ddbRollOwnership:{tag:"ddb-roll-ownership",label:game.i18n.localize("CRLNGN.settings.ddbRollOwnership.label"),hint:game.i18n.localize("CRLNGN.settings.ddbRollOwnership.hint"),propType:Number,choices:{1:game.i18n.localize("CRLNGN.settings.ddbRollOwnership.choices.gm.label"),2:game.i18n.localize("CRLNGN.settings.ddbRollOwnership.choices.player.label")},inputType:N.select,default:2,scope:w.world,config:!0},foundryRollModifiers:{tag:"foundry-roll-modifiers",label:game.i18n.localize("CRLNGN.settings.foundryRollModifiers.label"),hint:game.i18n.localize("CRLNGN.settings.foundryRollModifiers.hint"),propType:Boolean,inputType:N.checkbox,default:!0,scope:w.world,config:!0},forceDDBGL:{tag:"force-ddbgl-settings",label:game.i18n.localize("CRLNGN.settings.forceDDBGL.label"),hint:game.i18n.localize("CRLNGN.settings.forceDDBGL.hint"),propType:Boolean,inputType:N.checkbox,default:!0,scope:w.world,config:!0},removeTemplate:{tag:"remove-template",label:game.i18n.localize("CRLNGN.settings.removeTemplate.label"),hint:game.i18n.localize("CRLNGN.settings.removeTemplate.hint"),propType:Boolean,inputType:N.checkbox,default:!0,scope:w.world,config:!0},templateAutoTarget:{tag:"template-auto-target",label:game.i18n.localize("CRLNGN.settings.templateAutoTarget.label"),hint:game.i18n.localize("CRLNGN.settings.templateAutoTarget.hint"),propType:Number,choices:{1:game.i18n.localize("CRLNGN.settings.templateAutoTarget.choices.all.label"),2:game.i18n.localize("CRLNGN.settings.templateAutoTarget.choices.notFriendly.label"),3:game.i18n.localize("CRLNGN.settings.templateAutoTarget.choices.none.label")},inputType:N.checkbox,default:!0,scope:w.world,config:!0},skipRollConfig:{tag:"skip-roll-config",label:game.i18n.localize("CRLNGN.settings.skipRollConfig.label"),hint:game.i18n.localize("CRLNGN.settings.skipRollConfig.hint"),propType:Number,choices:{1:game.i18n.localize("CRLNGN.settings.skipRollConfig.choices.all.label"),2:game.i18n.localize("CRLNGN.settings.skipRollConfig.choices.ddbgl.label")},inputType:N.select,default:1,scope:w.world,config:!0},debugMode:{tag:"debug-mode",label:game.i18n.localize("CRLNGN.settings.debugMode.label"),hint:game.i18n.localize("CRLNGN.settings.debugMode.hint"),propType:Boolean,inputType:N.checkbox,default:!0,scope:w.client,config:!0}}}const $=class ${static log(e="",t=[],a=!1){try{const s=$.debugOn;if(!(a||s))return;console.log(...v,e,...t)}catch{console.log(...v,e,...t)}}static warn(e="",t=[]){console.warn(...v,e,...t)}static error(e="",t=[],a={ui:!1,console:!0,permanent:!1}){var s;console.log(...v,e,t,a),a.ui&&((s=ui.notifications)==null||s.error(e,{permanent:a.permanent})),a.console&&console.error(...v,e,...t)}};p($,"debugOn",!1);let o=$;class d{static getTargets(e){let t=game.users.find(s=>s.isGM===!0),a=e.targets||t.targets;return new Set([...a])}static getActorFromItem(e){const t=e.split(".")[1];return game.actors.get(t)}static isModuleOn(e){var a;const t=(a=game.modules)==null?void 0:a.get(e);return!!(t!=null&&t.active)}static parseDDBGLAbility(e){let t=null;const a=`${e}`;return W.forEach(s=>{a.toLowerCase().includes(s.name)&&(t=s)}),t}static isPrivateRoll(e){return e===CONST.DICE_ROLL_MODES.BLIND||e===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(e){o.log("removeTemplateForItem - A",[e]);const t=C.get("remove-template");if(o.log("removeTemplateForItem - B",[t]),!t)return;const a=canvas.templates.objects.children.filter(s=>s.document.flags.dnd5e.item===(e==null?void 0:e.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",a.map(s=>s.id))}static getUserFromActor(e){let t;if(!e)return null;const a=e?game.actors.get(e):null;return t=game.users.players.find(l=>l.active===!0&&l.character.id===e),t||game.users.players.forEach(l=>{l.active&&a.testUserPermission(l,foundry.CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,{exact:!0})&&(t=l)}),o.log("getUserFromActor",[e,t]),t}static html(e,t){return e.querySelector(t)}}p(d,"getClientTargets",()=>{if(!game.user)return[];const e=Array.from(game.user.targets);return o.log("Selected Targets",[game.user.id,e,e.filter(t=>t.actor)]),e}),p(d,"getTargetDescriptors",()=>{var t,a;const e=new Map;for(const s of game.user.targets){const{name:l}=s,{img:r,system:i,uuid:n,statuses:T}=s.actor??{};if(n){const c=T.has("coverTotal")?null:(a=(t=i.attributes)==null?void 0:t.ac)==null?void 0:a.value;e.set(n,{name:l,img:r,uuid:n,ac:c??null})}}return Array.from(e.values())}),p(d,"findItemFromActor",(e,t,a)=>{const s=game.actors.get(e);if(o.log("findItemFromActor",[t,a]),!s)return null;let l=t?s.items.find(r=>r.id===t):null;return l||(l=a?s.items.find(r=>r.name.toLowerCase()===a.toLowerCase()):null,l||(l=s.items.find(r=>r.name.toLowerCase()===(a+" (Legacy)").toLowerCase()))),l}),p(d,"addCSSVars",(e,t)=>{let a=document.querySelector("#crlngn-ddbgl-chat-vars");if(!a){const m=document.querySelector("body");a=document.createElement("style"),a.id="crlngn-ddbgl-chat-vars",a.textContent=`body.crlngn-ddbgl-chat {
}
`,m.prepend(a)}let s=a.textContent,l=s.indexOf("body.crlngn-ddbgl-chat {"),r=s.indexOf("}",l);l===-1&&(s=`body.crlngn-ddbgl-chat {
}
`,l=0,r=s.indexOf("}"));const n=s.substring(l+24,r).split(";").map(m=>m.trim()).filter(m=>m!==""),T={};n.forEach(m=>{const h=m.split(":");if(h.length>=2){const E=h[0].trim(),A=h.slice(1).join(":").trim();E&&(T[E]=A)}}),e.includes("i18n")&&typeof t=="string"&&!t.startsWith('"')&&!t.startsWith("'")&&!t.match(/^url\(|^rgba?\(|^hsla?\(/)&&(t=`"${t}"`),T[e]=t;const c=Object.entries(T).map(([m,h])=>`  ${m}: ${h};`).join(`
`),u=s.substring(0,l)+`body.crlngn-ddbgl-chat {
`+c+`
}`+s.substring(r+1);a.textContent=u});const k=class k{static registerSettings(){const e=D();document.querySelector("body").classList.add(_),Object.entries(e).forEach(async a=>{const s=a[1];o.log("Registering... ",[a]);const l={name:s.label,hint:s.hint,default:s.default,type:s.propType,scope:s.scope,config:s.config,requiresReload:s.requiresReload||!1,onChange:r=>k.apply(s.tag,r)};s.choices&&(l.choices=s.choices),await game.settings.register(V,s.tag,l),k.get(s.tag)===void 0&&k.set(s.tag,s.default),o.log("registerSettings",[s.tag,k.get(s.tag)])}),k.get(e.enableChatStyles.tag)?game.version.startsWith("12")?document.querySelector("body").classList.add("v12"):game.version.startsWith("13")&&document.querySelector("body").classList.add("v13"):document.querySelector("body").classList.remove("crlngn-ddbgl-chat"),k.applyDebugSettings()}static get(e,t=V){if(!e)return null;let a=!1;if(t===V)a=game.settings.get(t,e);else{let l=game.settings.storage.get("client")[`${t}.${e}`];l===void 0&&(l=game.settings.storage.get("world").getSetting(`${t}.${e}`)),a=l==null?void 0:l.value,o.log("GET Setting",[l,a])}return a}static set(e,t,a=V){if(!e)return!1;let s=game.settings.storage.get("client")[`${a}.${e}`];s||(s=game.settings.storage.get("world").getSetting(`${a}.${e}`));try{s&&s.update({value:t}),o.log("Able to change setting",[e,s])}catch{o.log("Unable to change setting",[e,s])}return!0}static apply(e,t){const a=D();switch(e){case a.forceDDBGL.tag:k.resetGamelogSettings();break;case a.debugMode.tag:k.applyDebugSettings();break}}static resetGamelogSettings(){const e=D();if(!d.isModuleOn("ddb-game-log"))return;const a=k.get("enable_chatcards","ddb-game-log"),s=k.get(e.forceDDBGL.tag);o.log("resetGamelogSettings",[a,s]),!a&&s&&k.set("enable_chatcards",!0,"ddb-game-log")}static applyDebugSettings(e){const t=D();o.debugOn=e||k.get(t.debugMode.tag)}};p(k,"currSettings");let C=k;const x=class x{static init(){const e=D();x.chatMsgSettings=C.get(e.enableChatStyles.tag)}static enrichCard(e,t){var s,l,r,i,n,T,c;if(!t){o.warn("ChatUtil.enrichCard: html element is null",[e]);return}o.log("enrichCard",[e,t]),t.classList.remove("ddb-game-log-open-card");const a=x.chatMsgSettings;if(a){const u=((r=(l=(s=e.flags)==null?void 0:s.dnd5e)==null?void 0:l.activity)==null?void 0:r.type)||((T=(n=(i=e.flags)==null?void 0:i.dnd5e)==null?void 0:n.roll)==null?void 0:T.type)||"custom";let m=t.get?t.get(0):t;m.classList.add("crlngn"),m.classList.add(u),(c=a.flags)!=null&&c["ddb-game-log"]&&t.classList.add("ddbgl");const h=m.querySelectorAll(".card-buttons button[data-action=rollSave]");h.length>0&&h.forEach(E=>{const A=E.querySelector(".visible-dc"),M=E.querySelector(".hidden-dc");A&&(A.setAttribute("data-ability",E.getAttribute("data-ability")||""),A.setAttribute("data-dc",E.getAttribute("data-dc")||"")),M&&M.setAttribute("data-ability",E.getAttribute("data-ability")||"")})}}};p(x,"chatMsgSettings");let B=x;class I{static getActivityFromItem(e,t){var n;let a=null;if(!e)return a;const s=(n=e.system)==null?void 0:n.activities,l=e.hasAttack,r=e.hasSave;o.log("getActivityFromItem",[s,typeof s,Array.isArray(s)]);const i=T=>{const c=s.find(u=>u.type==T);return o.log("activityByType",[e,T,s.size,c]),c};switch(t){case f.toHit.cls:a=i(f.toHit.actionType);break;case f.damage.cls:l?a=i(f.toHit.actionType):r?a=i(f.save.actionType):a=i(f.damage.actionType);break;case f.check.cls:a=i(f.check.actionType);break;case f.save.cls:a=i(f.save.actionType);break;case f.heal.cls:a=i(f.heal.actionType);break;case f.cast.cls:a=i(f.cast.actionType);break}return a??Array.from(s.keys())[0]??null}static async ddbglUse(e,t={},a={},s={}){var u,m,h,E,A,M;if(!e){ui.notifications.error("No activity found",{localize:!1});return}if(!e.item.isEmbedded||e.item.pack)return;if(!e.item.isOwner){ui.notifications.error("DND5E.DocumentUseWarn",{localize:!0});return}if(!e.canUse){ui.notifications.error("DND5E.ACTIVITY.Warning.UsageNotAllowed",{localize:!0});return}let l=e.item.clone({},{keepId:!0});const r=e._prepareUsageConfig(t);(u=r.create)!=null&&u.measuredTemplate&&((m=ui.notifications)==null||m.info(game.i18n.localize("CRLNGN.ui.notifications.clickMapToPlaceTemplate")));const i=foundry.utils.mergeObject({configure:!0,applicationClass:e.metadata.usage.dialog},a),n=foundry.utils.mergeObject({create:!0,data:{flags:{dnd5e:{...e.messageFlags,messageType:"usage",use:{effects:(h=e.applicableEffects)==null?void 0:h.map(O=>O.id)}},rsr5e:{processed:!0,quickRoll:!1}}},hasConsumption:r.hasConsumption},s);if(Hooks.call("dnd5e.preUseActivity",e,r,i,n)===!1)return;if(i.configure&&e._requiresConfigurationDialog(r))try{await i.applicationClass.create(e,r,i.options)}catch{return}await e._prepareUsageScaling(r,n,l),e=l.system.activities.get(e.id);const T=await e.consume(r,n);if(T===!1)return;const c={effects:[],templates:[],updates:T};if((E=r.concentration)!=null&&E.begin){const O=await l.actor.beginConcentrating(e,{"flags.dnd5e.scaling":r.scaling});if(O&&(c.effects??(c.effects=[]),c.effects.push(O),foundry.utils.setProperty(n.data,"flags.dnd5e.use.concentrationId",O.id)),(A=r.concentration)!=null&&A.end){const G=await l.actor.endConcentration(r.concentration.end);c.effects.push(...G)}}return o.log("ddbglUse - messageConfig",[n]),n.data.rolls=(n.data.rolls??[]).concat(T.rolls),e._finalizeMessageConfig(r,n,c),c.message=await I.createUsageMessage(e,n),o.log("ddbglUse - messageConfig",[n,c.message]),c.message.dnd5e=((M=n.flags)==null?void 0:M.dnd5e)??{},c.message.dnd5e.targets=d.getTargetDescriptors({actorId:c.message.speaker.actor}),c.message.flags={...c.message.flags,rsr5e:{processed:!0}},o.log("ddbglUse - results.message",[c.message]),await e._finalizeUsage(r,c),Hooks.call("dnd5e.postUseActivity",e,r,c)===!1||r.subsequentActions!==!1&&e._triggerSubsequentActions(r,c),c}static async createUsageMessage(e,t){let a=await e._usageChatContext(t),s=await Q(t.data.rolls);a={...a,rolls:s},o.log("createUsageMessage",[e.metadata.usage.chatCard,a]);const l=foundry.utils.mergeObject({rollMode:game.settings.get("core","rollMode"),data:{content:await renderTemplate(e.metadata.usage.chatCard,a),speaker:ChatMessage.getSpeaker({actor:e.item.actor}),flags:{core:{canPopout:!0},rsr5e:{processed:!0}}}},t);Hooks.callAll("dnd5e.preCreateUsageMessage",e,l),ChatMessage.applyRollMode(l.data,l.rollMode);const r=l.create===!1?l.data:await ChatMessage.create(l.data);return Hooks.callAll("dnd5e.postCreateUsageMessage",e,r),r}}const Q=async(g,e)=>{let t=[];return t=await Promise.all(g.map(async a=>{var n;const s=await a.getTooltip(),l=Number.isNumeric((n=a.options)==null?void 0:n.target),r=l&&a.total>=a.options.target,i=l&&a.total<a.options.target;return{...a,formula:a.formula,total:a.total,tooltipHtml:s,isSuccess:r,isFailure:i,hasTarget:l}})),t},R=class R{static serializeForTransport(e){var a;if(e==null)return e;o.log("Serializing data - Original structure",["Keys:",Object.keys(e||{}),"Has rolls:",!!e.rolls,"Rolls length:",(a=e.rolls)==null?void 0:a.length]);let t={...e};t.rolls&&Array.isArray(t.rolls)&&(o.log("Roll objects before serialization",["Roll count:",t.rolls.length,"Roll types:",t.rolls.map(s=>{var l;return((l=s==null?void 0:s.constructor)==null?void 0:l.name)||typeof s})]),t.rolls=t.rolls.map(s=>{if(s instanceof Roll){let l=s.toJSON();return o.log("Serialized roll",["Original:",s.formula,"Serialized keys:",Object.keys(l)]),l}else return s}));try{JSON.stringify(t),o.log("Data serialized successfully without circular references")}catch(s){o.error("Circular reference detected in data",["Error:",s.message,"Keys with potential circular refs:",Object.keys(t||{})]),t.actor&&o.log("Actor property exists",[typeof t.actor]),t.item&&o.log("Item property exists",[typeof t.item]),t.workflow&&o.log("Workflow property exists",[typeof t.workflow]),t.message&&o.log("Message property exists",[typeof t.message]),t.flags&&o.log("Flags property exists",[typeof t.flags,Object.keys(t.flags||{})]),t.speaker&&o.log("Speaker property exists",[typeof t.speaker,Object.keys(t.speaker||{})])}return t}static deserializeFromTransport(e){var a;o.log("Deserializing data - Received structure",["Data type:",typeof e,"Is null/undefined:",e==null,"Keys:",Object.keys(e||{}),"Has rolls:",!!(e!=null&&e.rolls),"Rolls length:",(a=e==null?void 0:e.rolls)==null?void 0:a.length]);let t={...e};if(!e)return t;if(e.rolls&&e.rolls.length>0){o.log("Roll data before deserialization",["Roll count:",e.rolls.length,"Roll types:",e.rolls.map(s=>typeof s)]);try{const s=t.rolls.map(l=>{let r=l;return typeof l=="string"?r=Roll.fromJSON(l):r=Roll.fromJSON(JSON.stringify(l)),o.log("Deserialized roll",["Result formula:",r.formula,"Result total:",r.total]),r});t.rolls=[...s]}catch(s){o.error("Error deserializing rolls",["Error:",s.message,"Roll data:",e.rolls])}}return t}};p(R,"socket"),p(R,"_activeExecutions",new Map),p(R,"initialize",e=>{Hooks.once(J.READY,()=>{if(o.log("Attempting to register module..."),typeof socketlib>"u"){o.error("SocketUtil Error: socketlib is not loaded. Ensure it is installed and enabled."),ui.notifications.error(game.i18n.localize("CRLNGN_ROLLS.notifications.socketlibMissing"),{permanent:!0});return}try{R.socket=socketlib.registerModule(V),e&&e(),o.log("SocketUtil | Module registered",[R.socket])}catch(t){o.log("Problem registering module",[t])}})}),p(R,"registerCall",(e,t)=>{R.socket?(R.socket.register(e,t),o.log("SocketUtil - Registered callback",[R.socket,e])):o.log("SocketUtil - Failed to register callback (socket not initialized)",[R.socket,e])}),p(R,"sendMessage",(e,t)=>{o.log("SocketUtil - sendMessage",[e]),t&&t()}),p(R,"execForGMs",async(e,...t)=>{if(!R.socket){o.log("SocketUtil - Socket not initialized. Cannot execute as GM.");return}return await R.socket.executeForAllGMs(e,...t)}),p(R,"execForAll",async(e,...t)=>{if(!R.socket){o.log("SocketUtil - Socket not initialized. Cannot execute for all clients.");return}return await R.socket.executeForEveryone(e,...t)}),p(R,"execForUser",async(e,t,...a)=>{if(!R.socket){o.log("SocketUtil - Socket not initialized. Cannot execute as user.");return}if(t===game.user.id)return o.log("SocketUtil - Preventing recursive call",[t]),null;const s=`${e}-${t}`;if(R._activeExecutions.has(s))return o.log("SocketUtil - Preventing recursive call",[s]),null;R._activeExecutions.set(s,!0);try{const l=await R.socket.executeAsUser(e,t,...a);return o.log("SocketUtil - Executed as user.",[l]),l}catch(l){return o.log("SocketUtil - Error executing as user",[l]),null}finally{R._activeExecutions.delete(s)}});let P=R;const b=class b{static resetRollGetters(e){return e._total=e._evaluateTotal(),e.resetFormula(),e}static replaceTerms(e,t){return e.terms=t.terms,e._total=e._evaluateTotal(),e.resetFormula(),e}static replaceDie(e,t){var l;if(!t||!e)return e;if(o.log("replaceDie",[t,e]),!t.terms)return o.error("replaceDie - replacer.terms is undefined",[t]),e;const a=t.terms.filter(r=>r instanceof Die||r.class==="Die")||[],s=((l=e==null?void 0:e.terms)==null?void 0:l.filter(r=>!(r instanceof Die||r.class==="Die")))||[];return e.terms=[...a,...s],e._total=e._evaluateTotal(),e.resetFormula(),e}static getDialogSetting(e,t){var l;const a=D(),s=C.get(a.skipRollConfig.tag);if(o.log("getDialogSetting",["skip mode: "+s,L.keysPressed,t]),((l=t.flags)==null?void 0:l["ddb-game-log"])!==void 0)return!1;switch(s){case 1:return L.keysPressed.indexOf("Shift")!=-1;default:return e}}};p(b,"streamlineDDBRoll",async(e,t,a,s,l)=>{o.log("streamlineDDBRoll - A",[s,l]);let r=s,i=l;e&&!game.user.isGM&&(r=P.deserializeFromTransport(s)),i.author=game.user;let n=null,T=game.user,c=a?d.findItemFromActor(i.speaker.actor,t,a):null,u=game.actors.get(i.actor._id);u&&(i.actor=u),o.log("streamlineDDBRoll - B",[i,r,game.messages.get(r.id||r._id)]);let m={},h=r.rolls[0];m.message={flavor:r.flavor,speaker:r.speaker,whisper:r.whisper,user:T,blind:r.blind||d.isPrivateRoll(i.rollMode),rollMode:i.rollMode},m.dialog={configure:!1},m.roll={subsequentActions:!1,formula:h.formula,consume:{resources:!1,spellSlot:!1},user:T,rolls:[r.rolls[0]],flags:{...r.flags,[_]:{processed:!0},dnd5e:{...r.flags.dnd5e},rsr5e:{processed:!0,quickRoll:!1}}},r.flags=m.roll.flags;try{switch(!0){case e===f.toHit.cls:n=I.getActivityFromItem(c,e)??null,await b.triggerAttack(n,r,i,m);break;case e===f.damage.cls:n=I.getActivityFromItem(c,e)??null,await b.triggerDamage(n,r,i,m);break;case(e===f.save.cls||e===f.check.cls):n=null,await b.triggerAbilityTest(e,r,i,m);break;case e===f.heal.cls:n=I.getActivityFromItem(c,e)??null,await b.triggerHeal(n,r,i,m);break;case e===f.custom.cls:n=null,await b.triggerCustomRoll(m,r,a,i);break;default:o.log("streamlineDDBRoll",[e])}}catch(E){return o.error("Error intercepting DDB roll",[E],{ui:!1,console:!0,permanent:!1}),ui.notifications.warn("Could not intercept the DDB roll"),!1}return!0}),p(b,"triggerAttack",async(e,t,a,s)=>{const l=D();let r,i,n;const T=d.isModuleOn("midi-qol");if(!e)throw new Error("No associated activity found.");const c=d.getTargetDescriptors({user:game.user});if(s.roll.target=c.length===1?c[0].ac:void 0,s.roll.flags.rsr5e={processed:!0},s.roll.flags.dnd5e.roll={type:z.attack},T)o.log("MidiQOL is not supported yet");else{if(n=e.metadata.usage.chatCard,e.metadata.usage.chatCard=`modules/${_}/templates/ddb-attack-info.hbs`,i=await e.rollAttack(s.roll,s.dialog,{create:!1,data:{...s.message}}),i.length<1)return;o.log("triggerAttack - before",[i,t.rolls,d.getTargetDescriptors({user:game.user})]),C.get(l.foundryRollModifiers.tag)?i[0]=b.replaceDie(i[0],t.rolls[0]):i[0]=b.replaceTerms(i[0],t.rolls[0]),o.log("triggerAttack - after",[i,t.rolls]),s.roll.subsequentActions=!1,r=await I.ddbglUse(e,s.roll,s.dialog,{create:!1,data:{rolls:[i[0]],user:s.message.user,speaker:s.message.speaker,flavor:`<span class="crlngn item-name">${e.item.name}:</span> <span class="crlngn ${t.flags["ddb-game-log"].cls.replace(" ","")}">${t.flags["ddb-game-log"].cls}</span>`,flags:{rsr5e:s.roll.flags.rsr5e,[_]:{processed:!0,data:{msg:t,msgData:a},rollMode:a.rollMode,cls:t.flags["ddb-game-log"].cls,flavor:`<span class="crlngn item-name">${e.item.name}:</span> <span class="crlngn ${t.flags["ddb-game-log"].cls.replace(" ","")}">${t.flags["ddb-game-log"].cls}</span>`}}}})}if(r.message.flags=r.message.flags??{},o.log("triggerAttack - before card",[i,r.message]),!T){const u=await ChatMessage.implementation.create(r.message,{rollMode:a.rollMode});o.log("USAGE RESULTS",[u,r,s.message,e.metadata])}e.metadata.usage.chatCard=n}),p(b,"triggerDamage",async(e,t,a,s)=>{var n;const l=D(),r=d.isModuleOn("midi-qol");let i=[];if(o.log("triggerDamage",[]),!e)throw new Error("No associated activity found.");if(r&&e.workflow,!r){i=[],e.attack||(o.log("Damage only activity",[i,e.metadata.usage.chatCard]),s.roll.subsequentActions=!1,await I.ddbglUse(e,s.roll,s.dialog,{create:!0,rollMode:a.rollMode,data:{rolls:[],user:s.message.user,speaker:s.message.speaker,flavor:"",flags:{rsr5e:s.roll.flags.rsr5e,[_]:{processed:!0,data:{msg:t,msgData:a},rollMode:a.rollMode,cls:t.flags["ddb-game-log"].cls,flavor:`<span class="crlngn item-name">${e.item.name}:</span> <span class="crlngn ${t.flags["ddb-game-log"].cls.replace(" ","")}">${t.flags["ddb-game-log"].cls}</span>`}}}}));try{if(i=await e.rollDamage({flags:s.roll.flags,consume:s.roll.consume,formula:s.roll.formula,user:s.roll.user},s.dialog,{create:!1,data:{...s.message,targets:d.getTargetDescriptors(),flags:{...s.message.flags,dnd5e:{...(n=s.message.flags)==null?void 0:n.dnd5e,targets:d.getTargetDescriptors()}}}}),i.length<1)return;C.get(l.foundryRollModifiers.tag)?i[0]=b.replaceDie(i[0],t.rolls[0]):i[0]=b.replaceTerms(i[0],t.rolls[0]),o.log("triggerAttack - after",[i,t.rolls]),s.roll.flags.dnd5e.roll={type:z.damage},s.message.flags=s.roll.flags,s.message.flags={...s.message,dnd5e:{...s.roll.flags.dnd5e,targets:d.getTargetDescriptors()},rsr5e:s.roll.flags.rsr5e}}catch(T){o.error("triggerDamage ERROR",[T])}await i[0].toMessage(s.message,{rollMode:a.rollMode}),setTimeout(()=>{d.removeTemplateForItem(e.item)},3e3)}}),p(b,"triggerAbilityTest",async(e,t,a,s)=>{const l=d.parseDDBGLAbility(t.flags["ddb-game-log"].flavor);let r;s.roll.flags.dnd5e.roll={type:e===f.check.cls?"ability":"save"},l&&(s.roll.flags.dnd5e.roll={type:e===f.check.cls?z.abilityCheck:z.abilitySave,ability:l.abbrev}),s.message.flags={dnd5e:s.roll.flags.dnd5e,rsr5e:s.roll.flags.rsr5e},e===f.save.cls?r=await a.actor.rollSavingThrow({ability:l==null?void 0:l.abbrev},s.dialog,{create:!1}):e===f.check.cls&&(r=await a.actor.rollAbilityCheck({ability:l==null?void 0:l.abbrev},s.dialog,{create:!1}),o.log("triggerAbilityTest",[r,s.message])),!(r.length<1)&&(b.replaceTerms(r[0],t.rolls[0]),await r[0].toMessage(s.message,{rollMode:a.rollMode}))}),p(b,"triggerHeal",async(e,t,a,s)=>{var i;const l=D();let r=[];o.log("Heal activity"),s.roll.subsequentActions=!1,s.roll.flags.dnd5e.roll={type:z.damage},await I.ddbglUse(e,s.roll,s.dialog,{create:!0,rollMode:a.rollMode,data:{rolls:[],user:s.message.user,speaker:s.message.speaker,flavor:"",flags:{rsr5e:s.roll.flags.rsr5e,[_]:{processed:!0,data:{msg:t,msgData:a},rollMode:a.rollMode,cls:t.flags["ddb-game-log"].cls,flavor:`<span class="crlngn item-name">${e.item.name}:</span> <span class="crlngn ${t.flags["ddb-game-log"].cls.replace(" ","")}">${t.flags["ddb-game-log"].cls}</span>`}}}});try{if(r=await e.rollDamage({flags:s.roll.flags,consume:s.roll.consume,formula:s.roll.formula,user:s.roll.user},s.dialog,{create:!1,data:{...s.message,flags:{...s.message.flags,dnd5e:{...(i=s.message.flags)==null?void 0:i.dnd5e,targets:d.getTargetDescriptors()}}}}),r.length<1)return;C.get(l.foundryRollModifiers.tag)?r[0]=b.replaceDie(r[0],t.rolls[0]):r[0]=b.replaceTerms(r[0],t.rolls[0]),o.log("triggerHeal - after",[r,t.rolls]),s.message.flags=s.roll.flags,s.message.flags={...s.message,dnd5e:{...s.roll.flags.dnd5e,targets:d.getTargetDescriptors()},rsr5e:s.roll.flags.rsr5e}}catch(n){o.error("triggerHeal ERROR",[n])}await r[0].toMessage(s.message,{rollMode:a.rollMode})}),p(b,"triggerCustomRoll",async(e,t,a,s)=>{e.message={...e.message,dnd5e:{...e.roll.flags.dnd5e},rsr5e:e.roll.flags.rsr5e},await t.rolls[0].toMessage(e.message,{...s})});let F=b;const S=class S{static init(){S.setupKeyListeners(),S.registerHooks()}static addCSSLocalization(){const e="CRLNGN.dnd5e.chatCard.buttons";o.log("Test",[game.i18n.translations,game.i18n.translations.CRLNGN]),o.log(`Full path being requested: ${e}.attack`),game.i18n.has(`${e}.attack`)?o.warn("Key exists"):o.warn(`Missing translation key: ${e}.attack`),d.addCSSVars("--crlngn-i18n-attack",game.i18n.localize(`${e}.attack`)),d.addCSSVars("--crlngn-i18n-damage",game.i18n.localize(`${e}.damage`)),d.addCSSVars("--crlngn-i18n-summons",game.i18n.localize(`${e}.summons`)),d.addCSSVars("--crlngn-i18n-healing",game.i18n.localize(`${e}.healing`)),d.addCSSVars("--crlngn-i18n-template",game.i18n.localize(`${e}.template`)),d.addCSSVars("--crlngn-i18n-consume",game.i18n.localize(`${e}.consume`)),d.addCSSVars("--crlngn-i18n-refund",game.i18n.localize(`${e}.refund`)),d.addCSSVars("--crlngn-i18n-macro",game.i18n.localize(`${e}.macro`)),d.addCSSVars("--crlngn-i18n-save-dc",game.i18n.localize(`${e}.savedc`))}static registerHooks(){P.initialize(()=>{o.log("SocketUtil - initialized with socket",[P.socket,game.system.utils.areKeysPressed])}),Hooks.once(H.INIT,()=>{S.isMidiOn=d.isModuleOn("midi-qol"),o.log("Initiating module",[],!0),document.querySelector("body").classList.add("crlngn-ddbgl-chat"),C.registerSettings(),S.registerActivityHooks(),S.registerRollHooks(),S.registerChatHooks(),S.registerTemplateHooks()}),Hooks.once(H.READY,()=>{if(!game.socket){ui.notifications.error("⚠️ DDB Bridge: Foundry needs to be restarted to enable socket functionality.",{permanent:!0}),o.error("Foundry restart required to enable sockets.");return}S.templateTargeting=C.get("template-auto-target"),C.resetGamelogSettings(),S.registerSocketFunction(),S.addCSSLocalization(),B.init()}),Hooks.on(H.CLOSE_SETTINGS_CONFIG,()=>{C.resetGamelogSettings()})}static registerSocketFunction(){P.registerCall("DDBRoll",F.streamlineDDBRoll)}static registerActivityHooks(){Hooks.on(y.PRE_USE_ACTIVITY,X),Hooks.on(y.POST_USE_ACTIVITY,Z)}static registerRollHooks(){Hooks.on(y.ROLL_ATTACK_V2,ne),Hooks.on(y.ROLL_DAMAGE_V2,ie),Hooks.on(y.PRE_ROLL_V2,ae),Hooks.on(y.PRE_ROLL_ATTACK_V2,re),Hooks.on(y.PRE_ROLL_DAMAGE_V2,oe),Hooks.on(y.PRE_ROLL_SAVING_THROW,le)}static registerChatHooks(){Hooks.on(y.RENDER_CHAT_MESSAGE,se),Hooks.on(H.PRE_CREATE_CHAT_MESSAGE,ee),Hooks.on(H.CREATE_CHAT_MESSAGE,te)}static registerTemplateHooks(){Hooks.on(H.REFRESH_MEASURED_TEMPLATE,ce)}static setupKeyListeners(){window.addEventListener("keydown",e=>{const t=e.key;S.keysPressed.indexOf(t)<0&&S.keysPressed.push(t)}),window.addEventListener("keyup",e=>{const t=e.key,a=S.keysPressed.indexOf(t);a>=0&&S.keysPressed.splice(a,1)})}};p(S,"keysPressed",[]),p(S,"isMidiOn",!1),p(S,"areKeysPressed"),p(S,"throttleTimers",{}),p(S,"templateTargeting",0);let L=S;const X=async(g,e,t,a)=>(o.log(y.PRE_USE_ACTIVITY,[e,t,a,L.keysPressed]),!0),Z=async(g,e,t)=>(o.log(y.POST_USE_ACTIVITY,[g,e,t]),!0),ee=(g,e,t,a)=>{var m,h,E,A,M;const s=D();let l=!1,r,i,n,T,c=!1,u=g;if(i=d.isModuleOn("ddb-game-log")&&((m=g.getFlag("ddb-game-log","cls"))==null?void 0:m.toLowerCase())||"",c=g.getFlag(_,"processed")||!1,o.log("onPreCreateChatMessage #A",[i,c]),i&&!c)if(r=e.actor||game.actors.get(e.speaker.actor)||null,n=((E=(h=e.flags)==null?void 0:h["ddb-game-log"])==null?void 0:E.itemId)||"",u.rolls=u.rolls&&u.rolls.length>0?[u.rolls[0]]:[e.rolls[0]],o.log("onPreCreateChatMessage #B",[u.flags,e.flags]),r){l=!0,u.flags={...u.flags,...e.flags},u.flags[_]&&(u.flags[_].processed=!0,c=!0);const O=document.createElement("div");O.innerHTML=e.flavor;let G=(A=O==null?void 0:O.querySelector("span:first-child"))==null?void 0:A.innerHTML.replace(":","");if(T=G?d.findItemFromActor(e.speaker.actor,n,G):null,!T&&(i===f.toHit.cls||i===f.damage.cls||i===f.heal.cls))return o.error("Could not find an item for the roll",[i,G,r.items]),!0;{const U=d.getUserFromActor((M=u.speaker)==null?void 0:M.actor),q=C.get(s.ddbRollOwnership.tag)==2;if(o.log("Main - onPreCreateChatMessage",[u,U,q]),U&&q){o.log("Main - Before serialization",[u]);const K=P.serializeForTransport(u);o.log("Main - After serialization",[K]),o.log("CHECK ROLL",[q,U,K,e]),P.execForUser("DDBRoll",U.id,i,n,G,K,e)}else o.log("Main - No serialization",[u]),F.streamlineDDBRoll(i,n,G,u,e)}}else return o.warn("Could not find the actor from DDB Gamelog roll"),!0;return!l||c},te=(g,e,t)=>{o.log(H.CREATE_CHAT_MESSAGE,[g,e,t])},se=(g,e)=>{o.log(y.RENDER_CHAT_MESSAGE,[g,e]),B.enrichCard(g,e)},ae=(g,e,t)=>{o.log(y.PRE_ROLL_V2,[g,e,t]),e.configure=F.getDialogSetting(e.configure,g),o.log("dialog configure",[e.configure])},le=(g,e,t)=>{o.log(y.PRE_ROLL_SAVING_THROW,[g,e,t])},re=(g,e,t)=>(o.log(y.PRE_ROLL_ATTACK_V2,[t,e,g]),!0),oe=(g,e,t)=>(L.templateTargeting=C.get("template-auto-target"),o.log(y.PRE_ROLL_DAMAGE_V2,[g,e,t,L.keysPressed]),!0),ie=(g,e,t)=>{o.log(y.ROLL_DAMAGE_V2,[game])},ne=async(g,e,t,a)=>{o.log(y.ROLL_ATTACK_V2,[g,e,t,a]),d.isModuleOn("midi-qol")&&o.log(y.ROLL_ATTACK_V2,[MidiQOL.getWorkflow])},ce=(g,e)=>{if(!g.isOwner)return;const t=`refresh-template-${g.id}`;L.throttleTimers[t]&&clearTimeout(L.throttleTimers[t]),L.throttleTimers[t]=setTimeout(()=>{let a=3;switch(L.templateTargeting){case 1:a=3;break;case 2:a=0;break;default:return}game.user.targets.forEach(l=>l.setTarget(!1,{releaseOthers:!1}));const s=[];for(let l of canvas.tokens.placeables)l.document.disposition<=a&&g.shape.contains(l.center.x-g.x,l.center.y-g.y)&&s.push(l);s.forEach((l,r)=>{l.setTarget(!0,{releaseOthers:r===0,groupSelection:!0})}),s.length>0&&game.user.broadcastActivity({targets:game.user.targets.ids}),delete L.throttleTimers[t]},50)};L.init();
//# sourceMappingURL=module.js.map
