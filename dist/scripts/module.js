var Le=Object.defineProperty;var ve=Object.getPrototypeOf;var Oe=Reflect.get;var Te=o=>{throw TypeError(o)};var Me=(o,s,e)=>s in o?Le(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e;var R=(o,s,e)=>Me(o,typeof s!="symbol"?s+"":s,e),ie=(o,s,e)=>s.has(o)||Te("Cannot "+e);var G=(o,s,e)=>(ie(o,s,"read from private field"),e?e.call(o):s.get(o)),$=(o,s,e)=>s.has(o)?Te("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(o):s.set(o,e),V=(o,s,e,t)=>(ie(o,s,"write to private field"),t?t.call(o,e):s.set(o,e),e),j=(o,s,e)=>(ie(o,s,"access private method"),e);var be=(o,s,e)=>Oe(ve(o),e,s);const T={toHit:{prop:"toHit",cls:"to hit",actionType:"attack",rollType:"attack"},damage:{prop:"damage",cls:"damage",actionType:"damage",rollType:"damage"},heal:{prop:"heal",cls:"heal",actionType:"heal",rollType:"heal"},save:{prop:"save",cls:"save",actionType:"save",rollType:"ability"},check:{prop:"check",cls:"check",actionType:"check",rollType:"ability"},custom:{prop:"custom",cls:"roll",actionType:"roll",rollType:"custom"},cast:{prop:"cast",cls:"cast",actionType:"cast",rollType:"cast"}},X="crlngn-ddb-bridge",N="crlngn-ddb-bridge",J=["%cCarolingian DDB Bridge","color: #003377; font-weight: bold;","|"],O={abilityCheck:"ability",abilitySave:"save",attack:"attack",check:"check",concentration:"concentration",damage:"damage",deathSave:"death",formula:"formula",healing:"heal",custom:"roll",skillCheck:"skill",toolCheck:"tool"},Ie=[{abbrev:"str",name:"strength"},{abbrev:"dex",name:"dexterity"},{abbrev:"con",name:"constitution"},{abbrev:"int",name:"intelligence"},{abbrev:"wis",name:"wisdom"},{abbrev:"cha",name:"charisma"}],L={CHAT_MESSAGE:"chatMessage",INIT:"init",READY:"ready",PRE_CREATE_CHAT_MESSAGE:"preCreateChatMessage",CREATE_CHAT_MESSAGE:"createChatMessage",RENDER_CHAT_MESSAGE:"renderChatMessage",CREATE_MEASURED_TEMPLATE:"createMeasuredTemplate",REFRESH_MEASURED_TEMPLATE:"refreshMeasuredTemplate",CLOSE_SETTINGS_CONFIG:"closeSettingsConfig"},C={PRE_ROLL_V2:"dnd5e.preRollV2",PRE_ROLL_ABILITY_TEST:"dnd5e.preRollAbilityTest",PRE_ROLL_ABILITY_SAVE:"dnd5e.preRollAbilitySave",PRE_ROLL_SAVING_THROW:"dnd5e.preRollSavingThrow",PRE_ROLL_ATTACK_V2:"dnd5e.preRollAttackV2",PRE_ROLL_CLASS_HIT_POINTS:"dnd5e.preRollClassHitPoints",PRE_ROLL_CONCENTRATION:"dnd5e.preRollConcentration",PRE_ROLL_DAMAGE_V2:"dnd5e.preRollDamageV2",PRE_ROLL_DEATH_SAVE:"dnd5e.preRollDeathSave",PRE_ROLL_FORMULA_V2:"dnd5e.preRollFormulaV2",PRE_ROLL_HIT_DIE_V2:"dnd5e.preRollHitDieV2",PRE_ROLL_INITIATIVE:"dnd5e.preRollInitiative",PRE_ROLL_NPC_HIT_POINTS:"dnd5e.preRollNPCHitPoints",PRE_ROLL_RECHARGE_V2:"dnd5e.preRollRechargeV2",PRE_ROLL_SKILL:"dnd5e.preRollSkill",PRE_ROLL_TOOL_CHECK:"dnd5e.preRollToolCheck",PRE_USE_ITEM:"dnd5e.preUseItem",ROLL_ABILITY_TEST:"dnd5e.rollAbilityTest",ROLL_ABILITY_SAVE:"dnd5e.rollAbilitySave",ROLL_ATTACK_V2:"dnd5e.rollAttackV2",ROLL_CLASS_HIT_POINTS:"dnd5e.rollClassHitPoints",ROLL_CONCENTRATION:"dnd5e.rollConcentration",ROLL_DEATH_SAVE:"dnd5e.rollDeathSave",ROLL_DAMAGE_V2:"dnd5e.rollDamageV2",ROLL_FORMULA_V2:"dnd5e.rollFormulaV2",ROLL_HIT_DIE_V2:"dnd5e.rollHitDieV2",ROLL_INITIATIVE:"dnd5e.rollInitiative",ROLL_NPC_HIT_POINTS:"dnd5e.rollNPCHitPoints",ROLL_RECHARGE_V2:"dnd5e.rollRechargeV2",ROLL_SKILL:"dnd5e.rollSkill",ROLL_TOOL_CHECK:"dnd5e.rollToolCheck",DISPLAY_CARD:"dnd5e.preDisplayCardV2",PRE_DISPLAY_CARD_V2:"dnd5e.preDisplayCardV2",RENDER_CHAT_MESSAGE:"dnd5e.renderChatMessage",PRE_LONG_REST:"dnd5e.preLongRest",PRE_REST_COMPLETED:"dnd5e.preRestCmpleted",PRE_SHORT_REST:"dnd5e.preShortRest",REST_COMPLETED:"dnd5e.restCmpleted",ACTIVITY_CONSUMPTION:"dnd5e.activityConsumption",POST_ACTIVITY_CONSUMPTION:"dnd5e.postActivityConsumption",POST_CREATE_USAGE_MESSAGE:"dnd5e.postCreateUsageMessage",POST_USE_ACTIVITY:"dnd5e.postUseActivity",PRE_ACTIVITY_CONSUMPTION:"dnd5e.preActivityConsumption",PRE_CREATE_USAGE_MESSAGE:"dnd5e.preCreateUsageMessage",PRE_USE_ACTIVITY:"dnd5e.preUseActivity"},U={select:"select",checkbox:"checkbox"},q={client:"client",world:"world"},de={debugMode:{tag:"debug-mode",label:"Debug Mode",hint:"Enable or disable debug messages on browser console",propType:Boolean,inputType:U.checkbox,default:!0,scope:q.client,config:!0},skipRollConfig:{tag:"skip-roll-config",label:"Skip roll configuration dialog?",hint:"Options: (1) skips configuration, but pressing 'shift' while rolling will open dialog; (2) Default behavior for Foundry rolls - press 'shift' to skip dialog. On rolls from D&D Beyond, dialog is never shown.",propType:Number,choices:{1:"1: Skip for all rolls",2:"2: Skip for DDB Gamelog rolls"},inputType:U.select,default:1,scope:q.world,config:!0},forceDDBGL:{tag:"force-ddbgl-settings",label:"Force DDB Gamelog settings",hint:"Automatically reset D&D Beyond Gamelog settings to make this module work better. Disabling this setting might disable integration with DDB Gamelog.",propType:Boolean,inputType:U.checkbox,default:!0,scope:q.world,config:!0},removeTemplate:{tag:"remove-template",label:"Remove Template after damage roll",hint:"When a spell has a template, remove the template after damage is rolled. This will only affect DDB Gamelog rolls. If the template has no damage roll, it is not removed.",propType:Boolean,inputType:U.checkbox,default:!0,scope:q.world,config:!0},templateAutoTarget:{tag:"template-auto-target",label:"Template Auto Targeting",hint:"When the template is drawn on canvas, should tokens be automatically targeted? This affects rolls from DDB Gamelog and Foundry",propType:Number,choices:{1:"1: Target all tokens",2:"2: Target non-friendly",3:"3: Do NOT auto target"},inputType:U.checkbox,default:!0,scope:q.world,config:!0}};class k{static getTargets(s){var t;let e=s.targets||game.user.targets||((t=canvas.tokens)==null?void 0:t.controlled);return new Set([...e])}static getTargetDescriptors(){var e,t;const s=new Map;for(const a of game.user.targets){const{name:i}=a,{img:r,system:n,uuid:l,statuses:c}=a.actor??{};if(l){const g=c.has("coverTotal")?null:(t=(e=n.attributes)==null?void 0:e.ac)==null?void 0:t.value;s.set(l,{name:i,img:r,uuid:l,ac:g??null})}}return Array.from(s.values())}static getActorFromItem(s){const e=s.split(".")[1];return game.actors.get(e)}static isModuleOn(s){var t;const e=(t=game.modules)==null?void 0:t.get(s);return!!(e!=null&&e.active)}static parseDDBGLAbility(s){let e=null;const t=`${s}`;return Ie.forEach(a=>{t.toLowerCase().includes(a.name)&&(e=a)}),e}static isPrivateRoll(s){return s===CONST.DICE_ROLL_MODES.BLIND||s===CONST.DICE_ROLL_MODES.PRIVATE}static removeTemplateForItem(s){p.log("removeTemplateForItem - A",[s]);const e=_.get("remove-template");if(p.log("removeTemplateForItem - B",[e]),!e)return;const t=canvas.templates.objects.children.filter(a=>a.document.flags.dnd5e.item===(s==null?void 0:s.uuid));canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate",t.map(a=>a.id))}static html(s,e){return s.querySelector(e)}}class _{static registerSettings(){document.querySelector("body").classList.add(N),Object.entries(de).forEach(async e=>{const t=e[1];p.log("Registering... ",[e]),await game.settings.register(X,t.tag,{name:t.label,hint:t.hint,default:t.default,type:t.propType,choices:t.choices||null,scope:t.scope,config:t.config,onChange:a=>_.apply(t.tag,a)}),_.get(t.tag)===void 0&&_.set(t.tag,t.default),p.log("registerSettings",[t.tag,_.get(t.tag)])})}static get(s,e=X){if(!s)return null;let t=!1;if(e===X)t=game.settings.get(e,s);else{let i=game.settings.storage.get("client")[`${e}.${s}`];i===void 0&&(i=game.settings.storage.get("world").getSetting(`${e}.${s}`)),t=i==null?void 0:i.value,p.log("GET Setting",[i,t])}return t}static set(s,e,t=X){if(!s)return!1;let a=game.settings.storage.get("client")[`${t}.${s}`];a||(a=game.settings.storage.get("world").getSetting(`${t}.${s}`));try{a&&a.update({value:e}),p.log("Able to change setting",[s,a])}catch{p.log("Unable to change setting",[s,a])}return!0}static apply(s,e){switch(s){case de.forceDDBGL.tag:_.resetGamelogSettings();break}}static resetGamelogSettings(){if(!k.isModuleOn("ddb-game-log"))return;const e=_.get("enable_chatcards","ddb-game-log"),t=_.get("force-ddbgl-settings");p.log("resetGamelogSettings",[e,t]),!e&&t&&_.set("enable_chatcards",!0,"ddb-game-log")}}class p{static log(s="",e=[],t=!1){try{const a=_.get(SETTINGS.debugMode.tag);if(!(t||a))return;console.log(...J,s,...e)}catch{console.log(...J,s,...e)}}static warn(s="",e=[]){console.warn(...J,s,...e)}static error(s,e){var t;e.ui&&((t=ui.notifications)==null||t.error(s,{localize:!0,permanent:e.permanent})),e.console&&console.error(...J,s)}}class he{static enrichCard(s,e){var n,l,c,g,m,d,u;const t=((c=(l=(n=s.flags)==null?void 0:n.dnd5e)==null?void 0:l.activity)==null?void 0:c.type)||((d=(m=(g=s.flags)==null?void 0:g.dnd5e)==null?void 0:m.roll)==null?void 0:d.type)||"custom";e.classList.remove("ddb-game-log-open-card"),e.classList.add("crlngn"),e.classList.add(t);let a=e.querySelector(".message-sender .subtitle"),i=e.querySelector(".message-sender .flavor-text"),r=e.querySelector(".message-header .flavor-text");if(!((u=s.flags)!=null&&u["ddb-game-log"])){const y=r==null?void 0:r.innerHTML;y?(a&&(a.innerHTML=y),i&&(i.innerHTML=y)):a&&(a.innerHTML="Message"),a.innerHTML=he.formatFlavorText(a.innerHTML,s,t)}}static formatFlavorText(s,e,t){var n,l,c,g;const a=game.actors.get(((n=e.speaker)==null?void 0:n.actor)||"")||null,i=(a==null?void 0:a.items.get(((g=(c=(l=e.flags)==null?void 0:l.dnd5e)==null?void 0:c.item)==null?void 0:g.id)||""))||null;let r=s||"Message";return t===O.attack?(p.log("renderChatMessage",[a,i]),i&&(r='<span class="item-name">'+(i==null?void 0:i.name),r=r+':</span> <span class="tohit">To Hit</span>')):t===O.damage?(p.log("renderChatMessage",[a,i]),i&&(r='<span class="item-name">'+(i==null?void 0:i.name),r=r+':</span> <span class="damage">Damage</span>')):t===O.healing?(p.log("renderChatMessage",[a,i]),i&&(r='<span class="item-name">'+((i==null?void 0:i.name)??"Action"),r=r+':</span> <span class="heal">Heal</span>')):s.includes("Skill Check")?(r='<span class="item-name">'+s,r=r.replace("Skill Check",':</span> <span class="check">Check</span>')):s.includes("Ability Check")?(r='<span class="item-name">'+s,r=r.replace("Ability Check",':</span> <span class="check">Check</span>')):s.includes("Saving Throw")?(r='<span class="item-name">'+s,r=r.replace("Saving Throw",':</span> <span class="save">Save</span>')):(t==="tool"||t==="check")&&s.includes("Check")?(r='<span class="item-name">'+s,r=r.replace("Check",':</span> <span class="check">Check</span>')):i?r=`<span class="item-name">${i.type}</span>`:r||(r='<span class="item-name">Info</span>'),r}}class v{static getActivityFromItem(s,e){var l;let t=null;if(!s)return t;const a=(l=s.system)==null?void 0:l.activities,i=s.hasAttack,r=s.hasSave,n=c=>{const g=a.find(m=>m.type==c);return p.log("activityByType",[s,c,a.size,g]),g};switch(e){case T.toHit.cls:t=n(T.toHit.actionType);break;case T.damage.cls:i?t=n(T.toHit.actionType):r?t=n(T.save.actionType):t=n(T.damage.actionType);break;case T.check.cls:t=n(T.check.actionType);break;case T.save.cls:t=n(T.save.actionType);break;case T.heal.cls:t=n(T.heal.actionType);break;case T.cast.cls:t=n(T.cast.actionType);break}return t??Array.from(a.keys())[0]??null}static async ddbglUse(s,e={},t={},a={},i=!1){var d,u,y,h,f,b;if(!s){ui.notifications.error("No activity found",{localize:!1});return}if(!s.item.isEmbedded||s.item.pack)return;if(!s.item.isOwner){ui.notifications.error("DND5E.DocumentUseWarn",{localize:!0});return}if(!s.canUse){ui.notifications.error("DND5E.ACTIVITY.Warning.UsageNotAllowed",{localize:!0});return}let r=s.item.clone({},{keepId:!0});const n=s._prepareUsageConfig(e);(d=n.create)!=null&&d.measuredTemplate&&((u=ui.notifications)==null||u.info("Click the map to place the template and see the roll. Right click to cancel",{localize:!1}));const l=foundry.utils.mergeObject({configure:!0,applicationClass:s.metadata.usage.dialog},t),c=foundry.utils.mergeObject({create:!0,data:{flags:{dnd5e:{...s.messageFlags,messageType:"usage",use:{effects:(y=s.applicableEffects)==null?void 0:y.map(w=>w.id)}},rsr5e:{processed:!0,quickRoll:!1}}},hasConsumption:n.hasConsumption},a);if(Hooks.call("dnd5e.preUseActivity",s,n,l,c)===!1)return;await s._prepareUsageScaling(n,c,r),s=r.system.activities.get(s.id);const g=await s.consume(n,c);if(g===!1)return;const m={effects:[],templates:[],updates:g};if((h=n.concentration)!=null&&h.begin){const w=await r.actor.beginConcentrating(s,{"flags.dnd5e.scaling":n.scaling});if(w&&(m.effects??(m.effects=[]),m.effects.push(w),foundry.utils.setProperty(c.data,"flags.dnd5e.use.concentrationId",w.id)),(f=n.concentration)!=null&&f.end){const F=await r.actor.endConcentration(n.concentration.end);m.effects.push(...F)}}return c.data.rolls=(c.data.rolls??[]).concat(g.rolls),m.message=await v.createUsageMessage(s,c),m.message.dnd5e=((b=c.flags)==null?void 0:b.dnd5e)??{},m.message.dnd5e.targets=k.getTargetDescriptors(),m.message.flags={...m.message.flags,rsr5e:{processed:!0}},await s._finalizeUsage(n,m),Hooks.call("dnd5e.postUseActivity",s,n,m)===!1||i&&s._triggerSubsequentActions&&s._triggerSubsequentActions(n,m),m}static async createUsageMessage(s,e){let t=await s._usageChatContext(e),a=await Pe(e.data.rolls);t={...t,rolls:a};const i=foundry.utils.mergeObject({rollMode:game.settings.get("core","rollMode"),data:{content:await renderTemplate(s.metadata.usage.chatCard,t),speaker:ChatMessage.getSpeaker({actor:s.item.actor}),flags:{core:{canPopout:!0},rsr5e:{processed:!0}}}},e);Hooks.callAll("dnd5e.preCreateUsageMessage",s,i),ChatMessage.applyRollMode(i.data,i.rollMode);const r=i.create===!1?i.data:await ChatMessage.create(i.data);return Hooks.callAll("dnd5e.postCreateUsageMessage",s,r),r}}const Pe=async(o,s)=>{let e=[];return e=await Promise.all(o.map(async t=>{const a=await t.getTooltip();return{...t,formula:t.formula,total:t.total,tooltipHtml:a}})),e},{OperatorTerm:De,RollTerm:Ne}=foundry.dice.terms;function re(o,{respectProperties:s}={}){const e=(i,r=[])=>[i,...s?Array.from(r).sort():[]].join(),t=new Map;for(const i of o){if(!i._evaluated)throw new Error("Only evaluated rolls can be aggregated.");for(const r of He(i.terms,i.options.type)){const n=e(r.type,i.options.properties);t.has(n)||t.set(n,{type:r.type,properties:new Set,terms:[]});const l=t.get(n);l.terms.push(new De({operator:r.negative?"-":"+"}),...r.terms),i.options.properties&&(l.properties=l.properties.union(new Set(i.options.properties)))}}const a=[];for(const i of t.values()){const r=new CONFIG.Dice.DamageRoll;r.terms=i.terms,r._total=r._evaluateTotal(),r._evaluated=!0,r.options={type:i.type,properties:Array.from(i.properties)},r.resetFormula(),a.push(r)}return a}function He(o,s){var n;const e=()=>{i.type??(i.type=s),a.push(i),i=null,r=!1},t=l=>l in CONFIG.DND5E.damageTypes||l in CONFIG.DND5E.healingTypes,a=[];let i,r=!1;for(let l of o){if(l instanceof De&&["+","-"].includes(l.operator)){i&&e(),l.operator==="-"&&(r=!r);continue}l=Ne.fromData(foundry.utils.deepClone(l.toJSON())),i??(i={terms:[],negative:r,type:null}),i.terms.push(l);const c=(n=l.flavor)==null?void 0:n.toLowerCase().trim();t(c)&&(i.type??(i.type=c),l.options.flavor="")}return i&&e(),a}const{ApplicationV2:Fe,HandlebarsApplicationMixin:Ge}=foundry.applications.api;class Re extends Ge(Fe){get subtitle(){return game.i18n.localize(this.options.window.subtitle??"")}_configureRenderOptions(s){var e;super._configureRenderOptions(s),s.isFirstRender&&this.hasFrame&&(s.window||(s.window={}),(e=s.window).subtitle||(e.subtitle=this.subtitle))}async _prepareContext(s){const e=await super._prepareContext(s);return e.CONFIG=CONFIG.DND5E,e.inputs={...foundry.applications.fields,...dnd5e.applications.fields},e}async _renderFrame(s){var a,i;const e=await super._renderFrame(s),t=document.createElement("h2");if(t.classList.add("window-subtitle"),e.querySelector(".window-title").insertAdjacentElement("afterend",t),(((a=s.window)==null?void 0:a.icon)??"").includes(".")){const r=e.querySelector(".window-icon"),n=document.createElement((i=s.window.icon)!=null&&i.endsWith(".svg")?"dnd5e-icon":"img");n.classList.add("window-icon"),n.src=s.window.icon,r.replaceWith(n)}return e}_updateFrame(s){super._updateFrame(s),s.window&&"subtitle"in s.window&&(this.element.querySelector(".window-header > .window-subtitle").innerText=s.window.subtitle)}_onRender(s,e){super._onRender(s,e),this.element.querySelectorAll("multi-select").forEach(t=>{t.disabled||t.querySelectorAll(".tag").forEach(a=>{var i;a.classList.add("remove"),(i=a.querySelector(":scope > span"))==null||i.classList.add("remove")})}),this.element.querySelectorAll(".label-top > p.hint").forEach(t=>{const a=t.parentElement.querySelector(":scope > label");a&&(t.ariaLabel=t.innerText,t.dataset.tooltip=t.innerHTML,t.innerHTML="",a.insertAdjacentElement("beforeend",t))})}_disableFields(){const s=`.window-content :is(${["INPUT","SELECT","TEXTAREA","BUTTON","DND5E-CHECKBOX","COLOR-PICKER","DOCUMENT-TAGS","FILE-PICKER","HUE-SLIDER","MULTI-SELECT","PROSE-MIRROR","RANGE-PICKER","STRING-TAGS"].join(", ")}):not(.interface-only)`;for(const e of this.element.querySelectorAll(s))e.tagName==="TEXTAREA"?e.readOnly=!0:e.disabled=!0}}R(Re,"DEFAULT_OPTIONS",{classes:["dnd5e2"],window:{subtitle:""}});const{DiceTerm:$e}=foundry.dice.terms;var I,z,P,Y,ue,te,_e;const x=class x extends Re{constructor(e={},t={},a={}){super(a);$(this,Y);$(this,I);$(this,z);$(this,P);V(this,I,e),V(this,z,t),j(this,Y,ue).call(this,foundry.utils.deepClone(G(this,I)))}static get rollType(){return CONFIG.Dice.BasicRoll}get config(){return G(this,I)}get message(){return G(this,z)}get rolls(){return G(this,P)}get rollType(){return this.options.rollType??this.constructor.rollType}_identifyDiceTerms(){let e=[],t=!0;const a=r=>{if(r instanceof $e){if(!Number.isFinite(r.number)||!Number.isFinite(r.faces)||!this.options.rendering.dice.denominations.has(r.denomination))return t=!1;for(let n=0;n<r.number;n++)e.push({icon:`systems/dnd5e/icons/svg/dice/${r.denomination}.svg`,label:r.denomination,denomination:r.denomination})}},i=(r=[])=>{for(const n of r)a(n),"dice"in n&&i(n.dice)};if(this.rolls.forEach(r=>i(r.terms)),e.length>this.options.rendering.dice.max){const r=e.reduce((n,{icon:l,denomination:c})=>(n[c]??(n[c]={icon:l,count:0}),n[c].count++,n),{});e=Object.entries(r).map(([n,{icon:l,count:c}])=>({icon:l,label:`${c}${n}`})),e.length>this.options.rendering.dice.max&&(t=!1)}else e.length||(t=!1);return t?e:[]}async _preparePartContext(e,t,a){switch(t=await super._preparePartContext(e,t,a),e){case"buttons":return this._prepareButtonsContext(t,a);case"configuration":return this._prepareConfigurationContext(t,a);case"formulas":return this._prepareFormulasContext(t,a);default:return t}}async _prepareButtonsContext(e,t){return e.buttons={roll:{icon:'<i class="fa-solid fa-dice"></i>',label:game.i18n.localize("DND5E.Roll")}},e}async _prepareConfigurationContext(e,t){var a;return e.fields=[{field:new foundry.data.fields.StringField({label:game.i18n.localize("DND5E.RollMode")}),name:"rollMode",value:this.message.rollMode??((a=this.options.default)==null?void 0:a.rollMode),options:Object.entries(CONFIG.Dice.rollModes).map(([i,r])=>({value:i,label:game.i18n.localize(r)}))}],e}async _prepareFormulasContext(e,t){return e.rolls=this.rolls.map(a=>({roll:a})),e.dice=this._identifyDiceTerms()||[],e}_buildConfig(e,t,a){e=foundry.utils.mergeObject({parts:[],data:{},options:{}},e),Hooks.callAll("dnd5e.buildRollConfig",this,e,t,a);const i=t==null?void 0:t.get(`roll.${a}.situational`);return i&&e.situational!==!1?(e.parts.push("@situational"),e.data.situational=i):e.parts.findSplice(r=>r==="@situational"),e}_finalizeRolls(e){return this.rolls}rebuild(){this._onChangeForm(this.options.form,new Event("change"))}_onChangeForm(e,t){super._onChangeForm(e,t);const a=new FormDataExtended(this.element);a.has("rollMode")&&(this.message.rollMode=a.get("rollMode")),j(this,Y,ue).call(this,foundry.utils.deepClone(G(this,I)),a),this.render({parts:["formulas"]})}_onClose(e={}){var t;(t=e.dnd5e)!=null&&t.submitted||V(this,P,[])}static async configure(e={},t={},a={}){return new Promise(i=>{const r=new this(e,a,t.options);r.addEventListener("close",()=>i(r.rolls),{once:!0}),r.render({force:!0})})}};I=new WeakMap,z=new WeakMap,P=new WeakMap,Y=new WeakSet,ue=function(e,t){var i;const a=this.rollType;V(this,P,((i=e.rolls)==null?void 0:i.map((r,n)=>a.fromConfig(this._buildConfig(r,t,n),this.config)))??[])},te=new WeakSet,_e=async function(e,t,a){var i,r;V(this,P,this._finalizeRolls((r=(i=e.submitter)==null?void 0:i.dataset)==null?void 0:r.action)),await this.close({dnd5e:{submitted:!0}})},$(x,te),R(x,"DEFAULT_OPTIONS",{classes:["roll-configuration","standard-form"],tag:"form",window:{title:"DND5E.RollConfiguration.Title",icon:"fa-solid fa-dice",minimizable:!1},form:{handler:j(x,te,_e)},position:{width:400},rendering:{dice:{max:5,denominations:new Set(["d4","d6","d8","d10","d12","d20"])}}}),R(x,"PARTS",{formulas:{template:"systems/dnd5e/templates/dice/roll-formulas.hbs"},configuration:{template:"systems/dnd5e/templates/dice/roll-configuration.hbs"},buttons:{template:"systems/dnd5e/templates/dice/roll-buttons.hbs"}});let Z=x;const B=class B extends Z{static get rollType(){return CONFIG.Dice.DamageRoll}async _prepareButtonsContext(s,e){var a;const t=((a=this.config.critical)==null?void 0:a.allow)!==!1;return s.buttons={critical:{icon:'<i class="fa-solid fa-bomb"></i>',label:game.i18n.localize("DND5E.CriticalHit")},normal:{icon:'<i class="fa-solid fa-dice"></i>',label:game.i18n.localize(t?"DND5E.Normal":"DND5E.Roll")}},t||delete s.buttons.critical,s}async _prepareFormulasContext(s,e){s=await super._prepareFormulasContext(s,e);const t=foundry.utils.mergeObject(CONFIG.DND5E.damageTypes,CONFIG.DND5E.healingTypes,{inplace:!1});return s.rolls=s.rolls.map(({roll:a})=>{var i,r;return{roll:a,damageConfig:t[a.options.type]??t[(i=a.options.types)==null?void 0:i[0]],damageTypes:((r=a.options.types)==null?void 0:r.length)>1?Object.entries(t).map(([n,l])=>{var c;return(c=a.options.types)!=null&&c.includes(n)?{value:n,label:l.label}:null}).filter(n=>n):null}}),s}_buildConfig(s,e,t){s=super._buildConfig(s,e,t);const a=e==null?void 0:e.get(`roll.${t}.damageType`);return a&&(s.options.type=a),s}_finalizeRolls(s){return this.rolls.map(e=>(e.options.isCritical=s==="critical",e.configureDamage({critical:this.config.critical}),e))}};R(B,"PARTS",{...be(B,B,"PARTS"),formulas:{template:"systems/dnd5e/templates/dice/damage-formulas.hbs"}});let ge=B;function ne(o,s){if(!o)return!1;const e={},t=(a,i)=>{e[a]=i,KeyboardManager.MODIFIER_CODES[a].forEach(r=>e[r]=i)};return t(KeyboardManager.MODIFIER_KEYS.CONTROL,o.ctrlKey||o.metaKey),t(KeyboardManager.MODIFIER_KEYS.SHIFT,o.shiftKey),t(KeyboardManager.MODIFIER_KEYS.ALT,o.altKey),game.keybindings.get("dnd5e",s).some(a=>game.keyboard.downKeys.has(a.key)&&a.modifiers.every(i=>e[i])?!0:a.modifiers.length?!1:e[a.key])}const{DiceTerm:Ve,NumericTerm:xe}=foundry.dice.terms,K=class K extends Roll{static fromConfig(s,e){const t=(s.parts??[]).join(" + ");return new this(t,s.data,s.options)}static async build(s={},e={},t={}){var i;this.applyKeybindings(s,e,t);let a;e.configure===!1?a=((i=s.rolls)==null?void 0:i.map(r=>this.fromConfig(r,s)))??[]:a=await(e.applicationClass??this.DefaultConfigurationDialog).configure(s,e,t);for(const r of a)await r.evaluate();return a!=null&&a.length&&t.create!==!1&&await this.toMessage(a,t.data,{rollMode:t.rollMode}),a}static applyKeybindings(s,e,t){e.configure??(e.configure=!0)}get isFailure(){if(this._evaluated)return Number.isNumeric(this.options.target)?this.total<this.options.target:!1}get isSuccess(){if(this._evaluated)return Number.isNumeric(this.options.target)?this.total>=this.options.target:!1}static async toMessage(s,e={},{rollMode:t,create:a=!0}={}){for(const n of s)n._evaluated||await n.evaluate({allowInteractive:t!==CONST.DICE_ROLL_MODES.BLIND}),t??(t=n.options.rollMode);e=foundry.utils.mergeObject({sound:CONFIG.sounds.dice},e),e.rolls=s;const i=getDocumentClass("ChatMessage"),r=new i(e);return a?i.create(r.toObject(),{rollMode:t}):(t&&r.applyRollMode(t),r.toObject())}async evaluate(s={}){return this.preCalculateDiceTerms(s),super.evaluate(s)}evaluateSync(s={}){return this.preCalculateDiceTerms(s),super.evaluateSync(s)}preCalculateDiceTerms(s={}){this._evaluated||!s.maximize&&!s.minimize||(this.terms=this.terms.map(e=>{if(e instanceof Ve&&e.modifiers.length){const t=!s.maximize,a=this.constructor.preCalculateTerm(e,{minimize:t});if(Number.isFinite(a))return new xe({number:a,options:e.options})}return e}))}static preCalculateTerm(s,{minimize:e=!1}={}){let t=e?1:s.faces,a=s.number;const i=foundry.utils.deepClone(s.modifiers),r=new Set(["k","kh","kl"]),n=new Set(["d","dh","dl"]),l=new Set([...r,...n,"max","min"]);let c=!1;for(const g of i){const m=/(m[ai][xn]|[kd][hl]?)(\d+)?/i,d=g.match(m);if(!d)continue;d[0].length<d.input.length&&i.push(d.input.slice(d[0].length));let[,u,y]=d;if(u=u.toLowerCase(),!l.has(u))continue;c=!0;const h=parseInt(y)||(u==="max"||u==="min"?-1:1);if(h>0){if(u==="max"&&e||u==="min"&&!e)continue;u==="max"||u==="min"?t=Math.min(s.faces,h):r.has(u)?a=Math.min(a,h):n.has(u)&&(a=Math.max(1,a-h))}}return c?t*a:null}simplify(){var s,e;for(const t of this.dice){const a=t._number;a instanceof K&&a.isDeterministic&&(t._number=a.evaluateSync().total);const i=t._faces;i instanceof K&&i.isDeterministic&&(t._faces=i.evaluateSync().total),(e=(s=i.terms)==null?void 0:s[0])!=null&&e.flavor&&(t.options.flavor=i.terms[0].flavor)}this.resetFormula()}};R(K,"DefaultConfigurationDialog",Z);let me=K;const{DiceTerm:Ue,FunctionTerm:qe,NumericTerm:Ce,OperatorTerm:le,ParentheticalTerm:oe,StringTerm:Q}=foundry.dice.terms;class pe extends me{constructor(s,e,t){super(s,e,t),this.options.preprocessed||this.preprocessFormula(),this.options.configured||this.configureDamage()}static fromConfig(s,e){const t=super.fromConfig(s,e);return e.critical&&t.configureDamage({critical:e.critical}),t}static async build(s={},e={},t={}){var a,i;return s.critical??(s.critical={}),(a=s.critical).multiplyNumeric??(a.multiplyNumeric=game.settings.get("dnd5e","criticalDamageModifiers")),(i=s.critical).powerfulCritical??(i.powerfulCritical=game.settings.get("dnd5e","criticalDamageMaxDice")),super.build(s,e,t)}static applyKeybindings(s,e,t){var i;const a={normal:ne(s.event,"skipDialogNormal")||ne(s.event,"skipDialogDisadvantage"),critical:ne(s.event,"skipDialogAdvantage")};e.configure??(e.configure=Object.values(a).every(r=>!r));for(const r of s.rolls)r.options??(r.options={}),(i=r.options).isCritical??(i.isCritical=a.critical)}get isCritical(){return this.options.isCritical===!0}preprocessFormula(){for(let[s,e]of this.terms.entries()){const t=this.terms[s+1],a=this.terms[s-1];if(e instanceof Q&&/^d\d+/.test(e.term)&&!(a instanceof oe)){const i=`1${e.term}`,r=new Roll(i).terms[0];this.terms.splice(s,1,r),e=r}else if(e instanceof oe&&a instanceof Q&&a.term.match(/^[0-9]*d$/)){if(e.isDeterministic){let i=`${a.term}${e.evaluate().total}`,r=2;t instanceof Q&&(i+=t.term,r+=1);const n=new Roll(i).terms[0];this.terms.splice(s-1,r,n),e=n}}else if((e instanceof oe||e instanceof qe)&&t instanceof Q&&t.term.match(/^d[0-9]*$/)&&e.isDeterministic){const i=`${e.evaluate().total}${t.term}`,r=new Roll(i).terms[0];this.terms.splice(s,2,r),e=r}}this.resetFormula(),this.options.preprocessed=!0}configureDamage({critical:s={}}={}){var t;foundry.utils.mergeObject(s,this.options.critical??{});const e=new Map;for(let[a,i]of this.terms.entries())if(i instanceof Ue){if(i._number instanceof Roll){if(!i._number.isDeterministic)continue;i._number._evaluated||i._number.evaluateSync()}if(i.options.baseNumber=i.options.baseNumber??i.number,i.number=i.options.baseNumber,this.isCritical){let r=s.multiplier??2;if(s.powerfulCritical){const l=Roll.create(i.formula).evaluateSync({maximize:!0}).total;if(l>0){const c=((t=i.flavor)==null?void 0:t.toLowerCase().trim())??game.i18n.localize("DND5E.PowerfulCritical");e.set(c,(e.get(c)??0)+l)}r=Math.max(1,r-1)}let n=s.bonusDice&&a===0?s.bonusDice:0;i.alter(r,n),i.options.critical=!0}}else s.multiplyNumeric&&i instanceof Ce&&(i.options.baseNumber=i.options.baseNumber??i.number,i.number=i.options.baseNumber,this.isCritical&&(i.number*=s.multiplier??2,i.options.critical=!0));if(s.powerfulCritical&&e.size)for(const[a,i]of e.entries())this.terms.push(new le({operator:"+"})),this.terms.push(new Ce({number:i,options:{flavor:a}}));if(this.isCritical&&s.bonusDamage){const a=new Roll(s.bonusDamage,this.data);a.terms[0]instanceof le||this.terms.push(new le({operator:"+"})),this.terms.push(...a.terms)}this.resetFormula(),this.options.configured=!0}async configureDialog(s={},e={}){return(await this.constructor.configureDialog([this],s,e))[0]??null}static async configureDialog(s,{title:e,defaultRollMode:t,defaultCritical:a=!1,template:i,allowCritical:r=!0}={},n={}){return foundry.utils.logCompatibilityWarning("The `configureDialog` on DamageRoll has been deprecated and is now handled through `DamageRoll.build`.",{since:"DnD5e 4.0",until:"DnD5e 4.4"}),await this.DefaultConfigurationDialog.configure({critical:{allow:r}},{options:{title:e}},{rollMode:t})}}R(pe,"DefaultConfigurationDialog",ge);const{Coin:Be,DiceTerm:Ee,Die:Ke,FunctionTerm:ze,NumericTerm:se,OperatorTerm:A,ParentheticalTerm:Se,RollTerm:Ye}=foundry.dice.terms;function ke(o,{preserveFlavor:s=!1,deterministic:e=!1}={}){var c;let t;try{t=new Roll(o)}catch(g){console.warn(`Unable to simplify formula '${o}': ${g}`)}if(Roll.validate(t.formula),s||(t.terms=Roll.parse(t.formula.replace(Ye.FLAVOR_REGEXP,""))),e){t.terms=fe(t.terms);const g=[];let m=[],d=!1,u;for(let y=t.terms.length-1;y>=0;){let h,f=t.terms[y];if(f instanceof Se&&(h=ke(f.term,{preserveFlavor:s,deterministic:e})),Number.isNumeric(h)){const b={number:h};s&&(b.options={flavor:f.flavor}),f=new se(b)}for(u=f.isDeterministic&&(!d||u),u?m.unshift(f):m=[],f=t.terms[--y];f instanceof A;){if(u&&m.unshift(f),f.operator==="*"||f.operator==="/"||f.operator==="%")d=!0;else for(d=!1;m.length;)g.unshift(m.pop());f=t.terms[--y]}}if(u)for(;m.length;)g.unshift(m.pop());t.terms=g}if(t.terms=fe(t.terms),/[*/]/.test(t.formula))return t.isDeterministic&&!/d\(/.test(t.formula)&&(!/\[/.test(t.formula)||!s)?String(new Roll(t.formula).evaluateSync().total):t.constructor.getFormula(t.terms);t.terms=we(t.terms),t.terms=Roll.simplifyTerms(t.terms);let{poolTerms:a,diceTerms:i,mathTerms:r,numericTerms:n}=Xe(t.terms);n=We(n??[]),i=je(i??[]);const l=[i,a,r,n].flat().filter(Boolean);return((c=l[0])==null?void 0:c.operator)==="+"&&l.shift(),t.constructor.getFormula(l)}function fe(o){return o.reduce((s,e)=>{const t=s[s.length-1],a=new Set([t==null?void 0:t.operator,e.operator]);return a.has(void 0)?s.push(e):a.has("+")&&a.has("-")?s.splice(-1,1,new A({operator:"-"})):a.has("-")&&a.size===1?s.splice(-1,1,new A({operator:"+"})):a.has("+")||s.push(e),s},[])}function We(o){const s=[],{annotated:e,unannotated:t}=Ae(o);if(t.length){const a=Roll.safeEval(Roll.getFormula(t));if(a===0)return[...e];a>0&&s.push(new A({operator:"+"})),s.push(new se({number:a}))}return[...s,...e]}function je(o){const{annotated:s,unannotated:e}=Ae(o),t=e.reduce((i,r,n)=>{var d;if(r instanceof A)return i;const l=((d=r.constructor)==null?void 0:d.name)==="Coin",c=l?"c":r.faces,g=l?"":r.modifiers.filterJoin(""),m=`${e[n-1].operator}${c}${g}`;return i[m]??(i[m]={}),r._number instanceof Roll&&r._number.isDeterministic&&r._number.evaluateSync(),i[m].number=(i[m].number??0)+r.number,l||(i[m].modifiers=(i[m].modifiers??[]).concat(r.modifiers)),i},{});return[...Object.entries(t).flatMap(([i,{number:r,modifiers:n}])=>[new A({operator:i.charAt(0)}),i.slice(1)==="c"?new Be({number:r}):new Ke({number:r,faces:parseInt(i.slice(1)),modifiers:[...new Set(n)]})]),...s]}function we(o){return o=o.reduce((s,e)=>{if(e instanceof Se)if(e.isDeterministic){const t=new Roll(e.term);e=new se({number:t.evaluateSync().total})}else{const t=new Roll(e.term).terms;e=we(t)}return s.push(e),s},[]),fe(o.flat())}function Xe(o){return o[0]instanceof A||o.unshift(new A({operator:"+"})),o.reduce((s,e,t)=>{let a;e instanceof Ee?a=Ee:e instanceof ze&&e.isDeterministic?a=se:a=e.constructor;const i=`${a.name.charAt(0).toLowerCase()}${a.name.substring(1)}s`;return(s[i]=s[i]??[]).push(o[t-1],e),s},{})}function Ae(o){return o.reduce((s,e,t)=>(e instanceof A||s[e.flavor?"annotated":"unannotated"].push(o[t-1],e),s),{annotated:[],unannotated:[]})}class ce extends ChatMessage{constructor(){super(...arguments);R(this,"_highlighted",null)}get canApplyDamage(){var t,a,i;const e=(a=(t=this.flags.dnd5e)==null?void 0:t.roll)==null?void 0:a.type;return e&&e!=="damage"?!1:this.isRoll&&this.isContentVisible&&!!((i=canvas.tokens)!=null&&i.controlled.length)}get canSelectTargets(){var e,t;return((t=(e=this.flags.dnd5e)==null?void 0:e.roll)==null?void 0:t.type)!=="attack"?!1:this.isRoll&&this.isContentVisible}get isRoll(){var e;return super.isRoll&&!((e=this.flags.dnd5e)!=null&&e.rest)}get shouldDisplayChallenge(){if(game.user.isGM||this.author===game.user)return!0;switch(game.settings.get("dnd5e","challengeVisibility")){case"all":return!0;case"player":return!this.author.isGM;default:return!1}}static migrateData(e){if(e=super.migrateData(e),foundry.utils.hasProperty(e,"flags.dnd5e.itemData")&&(foundry.utils.setProperty(e,"flags.dnd5e.item.data",e.flags.dnd5e.itemData),delete e.flags.dnd5e.itemData),foundry.utils.hasProperty(e,"flags.dnd5e.use")){const t=e.flags.dnd5e.use;foundry.utils.setProperty(e,"flags.dnd5e.messageType","usage"),t.type&&foundry.utils.setProperty(e,"flags.dnd5e.item.type",t.type),t.itemId&&foundry.utils.setProperty(e,"flags.dnd5e.item.id",t.itemId),t.itemUuid&&foundry.utils.setProperty(e,"flags.dnd5e.item.uuid",t.itemUuid)}return e}prepareData(){super.prepareData(),this._shimFlags(),dnd5e.registry.messages.track(this)}async getHTML(...e){const t=await super.getHTML();return this._displayChatActionButtons(t),this._highlightCriticalSuccessFailure(t),game.settings.get("dnd5e","autoCollapseItemCards")&&t.find(".description.collapsible").each((a,i)=>i.classList.add("collapsed")),this._enrichChatCard(t[0]),this._collapseTrays(t[0]),this._activateActivityListeners(t[0]),Hooks.callAll("dnd5e.renderChatMessage",this,t[0]),t}_collapseTrays(e){let t;switch(game.settings.get("dnd5e","autoCollapseChatTrays")){case"always":t=!0;break;case"never":t=!1;break;case"older":t=this.timestamp<Date.now()-5*60*1e3;break}for(const a of e.querySelectorAll(".card-tray, .effects-tray"))a.classList.toggle("collapsed",t);for(const a of e.querySelectorAll("damage-application, effect-application"))a.toggleAttribute("open",!t)}_displayChatActionButtons(e){var a;const t=e.find(".dnd5e.chat-card, .dnd5e2.chat-card");if(t.length>0){const i=e.find(".flavor-text");i.text()===e.find(".item-name").text()&&i.remove(),this.shouldDisplayChallenge&&(t[0].dataset.displayChallenge="");const r=game.actors.get(this.speaker.actor),n=game.user.isGM||(r==null?void 0:r.isOwner)||this.author.id===game.user.id;for(const l of e[0].querySelectorAll(".card-buttons button"))l.dataset.visibility!=="all"&&(l.dataset.visibility==="gm"&&!game.user.isGM||!n||(a=this.getAssociatedActivity())!=null&&a.shouldHideChatButton(l,this))&&(l.hidden=!0)}}_highlightCriticalSuccessFailure(e){if(!this.isContentVisible||!this.rolls.length)return;const t=this.getOriginatingMessage(),a=t==null?void 0:t.shouldDisplayChallenge,i=game.user.isGM||game.settings.get("dnd5e","attackRollVisibility")!=="none";function r(n){const l=document.createElement("i");return l.classList.add("fas",n),l.setAttribute("inert",""),l}for(let[n,l]of this.rolls.entries()){const c=l.dice[0];if((c==null?void 0:c.faces)!==20||(c==null?void 0:c.values.length)!==1)continue;l=dnd5e.dice.D20Roll.fromRoll(l);const g=l.dice[0];if("success"in g.results[0]||g.options.marginSuccess||g.options.marginFailure)continue;const d=e.find(".dice-total")[n];if(!d)continue;const u=["attack","death"].includes(this.getFlag("dnd5e","roll.type")),h=this.getFlag("dnd5e","roll.type")==="attack"?i:a;g.options.target&&h&&(l.total>=g.options.target?d.classList.add("success"):d.classList.add("failure")),u&&l.isCritical&&d.classList.add("critical"),u&&l.isFumble&&d.classList.add("fumble");const f=document.createElement("div");f.classList.add("icons"),d.classList.contains("critical")?f.append(r("fa-check"),r("fa-check")):d.classList.contains("fumble")?f.append(r("fa-xmark"),r("fa-xmark")):d.classList.contains("success")?f.append(r("fa-check")):d.classList.contains("failure")&&f.append(r("fa-xmark")),f.children.length&&d.append(f)}}_enrichChatCard(e){var f,b,w,F,W,ye;const t=this.getAssociatedActor();let a,i;this.isContentVisible?(a=(t==null?void 0:t.img)??this.author.avatar,i=this.alias):(a=this.author.avatar,i=this.author.name);const r=document.createElement("a");r.classList.add("avatar"),t&&(r.dataset.uuid=t.uuid),r.innerHTML=`<img src="${a}" alt="${i}">`;const n=document.createElement("span");n.classList.add("name-stacked"),n.innerHTML=`<span class="title">${i}</span>`;const l=document.createElement("span");l.classList.add("subtitle"),this.whisper.length&&(l.innerText=((f=e.querySelector(".whisper-to"))==null?void 0:f.innerText)??""),i!==((b=this.author)==null?void 0:b.name)&&!l.innerText.length&&(l.innerText=((w=this.author)==null?void 0:w.name)??""),n.appendChild(l);const c=e.querySelector(".message-sender");c==null||c.replaceChildren(r,n),(F=e.querySelector(".whisper-to"))==null||F.remove();const g=e.querySelector(".message-metadata"),m=g.querySelector(".message-delete");game.user.isGM||m==null||m.remove();const d=document.createElement("a");d.setAttribute("aria-label",game.i18n.localize("DND5E.AdditionalControls")),d.classList.add("chat-control"),d.dataset.contextMenu="",d.innerHTML='<i class="fas fa-ellipsis-vertical fa-fw"></i>',g.appendChild(d),e.querySelectorAll("i.dnd5e-icon").forEach(S=>{const M=document.createElement("dnd5e-icon");M.src=S.dataset.src,S.replaceWith(M)});const u=this.getFlag("dnd5e","roll"),y=this.getAssociatedItem(),h=this.getAssociatedActivity();if(this.isContentVisible&&y&&u){const S=u.type==="damage"&&((W=this.rolls[0])==null?void 0:W.isCritical),M=u.type==="damage"?S?game.i18n.localize("DND5E.CriticalHit"):game.i18n.localize("DND5E.DamageRoll"):u.type==="attack"?(h==null?void 0:h.getActionLabel(u.attackMode))??"":((ye=y.system.type)==null?void 0:ye.label)??game.i18n.localize(CONFIG.Item.typeLabels[y.type]),ae=document.createElement("div");ae.classList.add("dnd5e2","chat-card"),ae.innerHTML=`
        <section class="card-header description ${S?"critical":""}">
          <header class="summary">
            <img class="gold-icon" src="${y.img}" alt="${y.name}">
            <div class="name-stacked">
              <span class="title">${y.name}</span>
              <span class="subtitle">${M}</span>
            </div>
          </header>
        </section>
      `,e.querySelector(".message-header .flavor-text").remove(),e.querySelector(".message-content").insertAdjacentElement("afterbegin",ae)}this._enrichAttackTargets(e),this.isContentVisible?(e.querySelectorAll(".dice-tooltip").forEach((S,M)=>{!(u instanceof pe)&&this.rolls[M]&&this._enrichRollTooltip(this.rolls[M],S)}),this._enrichDamageTooltip(this.rolls.filter(S=>S instanceof pe),e),this._enrichEnchantmentTooltip(e),e.querySelectorAll(".dice-roll").forEach(S=>S.addEventListener("click",this._onClickDiceRoll.bind(this)))):e.querySelectorAll(".dice-roll").forEach(S=>S.classList.add("secret-roll")),this._enrichUsageEffects(e),r.addEventListener("click",this._onTargetMouseDown.bind(this)),r.addEventListener("pointerover",this._onTargetHoverIn.bind(this)),r.addEventListener("pointerout",this._onTargetHoverOut.bind(this))}_enrichRollTooltip(e,t){const a=Number(ke(e._formula,{deterministic:!0}));if(!a)return;const i=a<0?"-":"+",r=document.createElement("section");r.classList.add("tooltip-part","constant"),r.innerHTML=`
      <div class="dice">
        <ol class="dice-rolls"></ol>
        <div class="total">
          <span class="value"><span class="sign">${i}</span>${Math.abs(a)}</span>
        </div>
      </div>
    `,t.appendChild(r)}_enrichAttackTargets(e){var g,m;const t=this.rolls[0],a=game.settings.get("dnd5e","attackRollVisibility");if(!(game.user.isGM||a!=="none")||!(t instanceof dnd5e.dice.D20Roll))return;const r=CONFIG.DND5E.weaponMasteries[t.options.mastery];if(r){const d=document.createElement("p");d.classList.add("supplement");let u=r.label;r.reference&&(u=`
        <a class="content-link" draggable="true" data-link data-uuid="${r.reference}"
           data-tooltip="${u}">${u}</a>
      `),d.innerHTML=`<strong>${game.i18n.format("DND5E.WEAPON.Mastery.Flavor")}</strong> ${u}`,(g=e.querySelector(".chat-card")??e.querySelector(".message-content"))==null||g.appendChild(d)}const n=this.getFlag("dnd5e","targets");if(!(n!=null&&n.length))return;const l=document.createElement("div");l.classList.add("dnd5e2"),l.innerHTML=`
      <div class="card-tray targets-tray collapsible collapsed">
        <label class="roboto-upper">
          <i class="fas fa-bullseye" inert></i>
          <span>${game.i18n.localize("DND5E.TargetPl")}</span>
          <i class="fas fa-caret-down" inert></i>
        </label>
        <div class="collapsible-content">
          <ul class="dnd5e2 unlist evaluation wrapper"></ul>
        </div>
      </div>
    `;const c=l.querySelector("ul");c.innerHTML=n.map(({name:d,ac:u,uuid:y})=>{!game.user.isGM&&a!=="all"&&(u="");const h=!t.isCritical&&(t.total<u||t.isFumble);return[`
        <li data-uuid="${y}" class="target ${h?"miss":"hit"}">
          <i class="fas ${h?"fa-times":"fa-check"}"></i>
          <div class="name">${d}</div>
          ${u!==""?`
          <div class="ac">
            <i class="fas fa-shield-halved"></i>
            <span>${u===null?"&infin;":u}</span>
          </div>
          `:""}
        </li>
      `,h]}).sort((d,u)=>d[1]===u[1]?0:d[1]?1:-1).reduce((d,[u])=>d+u,""),c.querySelectorAll("li.target").forEach(d=>{d.addEventListener("click",this._onTargetMouseDown.bind(this)),d.addEventListener("pointerover",this._onTargetHoverIn.bind(this)),d.addEventListener("pointerout",this._onTargetHoverOut.bind(this))}),(m=e.querySelector(".message-content"))==null||m.appendChild(l)}_enrichDamageTooltip(e,t){var m;if(!e.length)return;const a=CONFIG.DND5E.aggregateDamageDisplay?re(e):e;let{formula:i,total:r,breakdown:n}=a.reduce((d,u)=>(d.formula.push(CONFIG.DND5E.aggregateDamageDisplay?u.formula:` + ${u.formula}`),d.total+=u.total,d.breakdown.push(this._simplifyDamageRoll(u)),d),{formula:[],total:0,breakdown:[]});i=i.join("").replace(/^ \+ /,""),t.querySelectorAll(".dice-roll").forEach(d=>d.remove());const l=document.createElement("div");l.classList.add("dice-roll");const c=n.reduce((d,{type:u,total:y,constant:h,dice:f})=>{const b=CONFIG.DND5E.damageTypes[u]??CONFIG.DND5E.healingTypes[u];return`${d}
        <section class="tooltip-part">
          <div class="dice">
            <ol class="dice-rolls">
              ${f.reduce((w,{result:F,classes:W})=>`
                ${w}<li class="roll ${W}">${F}</li>
              `,"")}
              ${h?`
              <li class="constant"><span class="sign">${h<0?"-":"+"}</span>${Math.abs(h)}</li>
              `:""}
            </ol>
            <div class="total">
              ${b?`<img src="${b.icon}" alt="${b.label}">`:""}
              <span class="label">${(b==null?void 0:b.label)??""}</span>
              <span class="value">${y}</span>
            </div>
          </div>
        </section>
      `},"");l.innerHTML=`
      <div class="dice-result">
        <div class="dice-formula">${i}</div>
        <div class="dice-tooltip-collapser">
          <div class="dice-tooltip">
            ${c}
          </div>
        </div>
        <h4 class="dice-total">${r}</h4>
      </div>
    `,t.querySelector(".message-content").appendChild(l);const g=this.getFlag("dnd5e","roll.damageOnSave");if(g){const d=document.createElement("p");d.classList.add("supplement"),d.innerHTML=`<strong>${game.i18n.format("DND5E.SAVE.OnSave")}</strong> ${game.i18n.localize(`DND5E.SAVE.FIELDS.damage.onSave.${g.capitalize()}`)}`,(m=t.querySelector(".chat-card, .message-content"))==null||m.appendChild(d)}if(game.user.isGM){const d=document.createElement("damage-application");d.classList.add("dnd5e2"),d.damages=re(e,{respectProperties:!0}).map(u=>({value:u.total,type:u.options.type,properties:new Set(u.options.properties??[])})),t.querySelector(".message-content").appendChild(d)}}_simplifyDamageRoll(e){const t={type:e.options.type,total:e.total,constant:0,dice:[]};let a=!1;for(let i=e.terms.length-1;i>=0;){const r=e.terms[i--];if(!(r instanceof foundry.dice.terms.NumericTerm)&&!(r instanceof foundry.dice.terms.DiceTerm))continue;const n=r.total;r instanceof foundry.dice.terms.DiceTerm&&t.dice.push(...r.results.map(g=>({result:r.getResultLabel(g),classes:r.getResultCSS(g).filterJoin(" ")})));let l=1,c=e.terms[i];for(;c instanceof foundry.dice.terms.OperatorTerm;)["+","-"].includes(c.operator)||(a=!0),c.operator==="-"&&(l*=-1),c=e.terms[--i];r instanceof foundry.dice.terms.NumericTerm&&(t.constant+=n*l)}return a&&(t.constant=null),t}_enrichEnchantmentTooltip(e){var n,l;if(!this.getFlag("dnd5e","use.enchantmentProfile"))return;const a=this.getFlag("dnd5e","use.concentrationId");if(a&&!((n=this.getAssociatedActor())!=null&&n.effects.get(a)))return;const i=document.createElement("enchantment-application");i.classList.add("dnd5e2");const r=e.querySelector(".card-footer");r?r.insertAdjacentElement("beforebegin",i):(l=e.querySelector(".chat-card"))==null||l.append(i)}_enrichUsageEffects(e){var r;const t=this.getAssociatedItem();let a;if(this.getFlag("dnd5e","messageType")==="usage")a=(r=this.getFlag("dnd5e","use.effects"))==null?void 0:r.map(n=>t==null?void 0:t.effects.get(n));else{if(this.getFlag("dnd5e","roll.type"))return;a=t==null?void 0:t.effects.filter(n=>{var l;return n.type!=="enchantment"&&!((l=t.getFlag("dnd5e","riders.effect"))!=null&&l.includes(n.id))})}if(a=a==null?void 0:a.filter(n=>n&&(game.user.isGM||n.transfer&&this.author.id===game.user.id)),!(a!=null&&a.length))return;const i=document.createElement("effect-application");i.classList.add("dnd5e2"),i.effects=a,e.querySelector(".message-content").appendChild(i)}static addChatMessageContextOptions(e,t){const a=([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.canApplyDamage},i=([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.canSelectTargets};return t.push({name:game.i18n.localize("DND5E.ChatContextDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,1)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextHealing"),icon:'<i class="fas fa-user-plus"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,-1)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextTempHP"),icon:'<i class="fas fa-user-clock"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardTemp(r)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextDoubleDamage"),icon:'<i class="fas fa-user-injured"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,2)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextHalfDamage"),icon:'<i class="fas fa-user-shield"></i>',condition:a,callback:r=>{var n;return(n=game.messages.get(r.data("messageId")))==null?void 0:n.applyChatCardDamage(r,.5)},group:"damage"},{name:game.i18n.localize("DND5E.ChatContextSelectHit"),icon:'<i class="fas fa-bullseye"></i>',condition:i,callback:([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.selectTargets(r,"hit")},group:"attack"},{name:game.i18n.localize("DND5E.ChatContextSelectMiss"),icon:'<i class="fas fa-bullseye"></i>',condition:i,callback:([r])=>{var n;return(n=game.messages.get(r.dataset.messageId))==null?void 0:n.selectTargets(r,"miss")},group:"attack"}),t}_activateActivityListeners(e){var t;(t=this.getAssociatedActivity())==null||t.activateChatListeners(this,e)}async _onTargetMouseDown(e){var n;e.stopPropagation();const t=e.currentTarget.dataset.uuid,a=fromUuidSync(t),i=((n=a==null?void 0:a.token)==null?void 0:n.object)??(a==null?void 0:a.getActiveTokens()[0]);if(!i||!a.testUserPermission(game.user,"OBSERVER"))return;const r=!e.shiftKey;if(i.controlled)i.release();else return i.control({releaseOthers:r}),canvas.animatePan(i.center)}_onTargetHoverIn(e){var r;const t=e.currentTarget.dataset.uuid,a=fromUuidSync(t),i=((r=a==null?void 0:a.token)==null?void 0:r.object)??(a==null?void 0:a.getActiveTokens()[0]);i&&i.isVisible&&(i.controlled||i._onHoverIn(e,{hoverOutOthers:!0}),this._highlighted=i)}_onTargetHoverOut(e){this._highlighted&&this._highlighted._onHoverOut(e),this._highlighted=null}applyChatCardDamage(e,t){const a=re(this.rolls,{respectProperties:!0}).map(i=>({value:i.total,type:i.options.type,properties:new Set(i.options.properties??[])}));return Promise.all(canvas.tokens.controlled.map(i=>{var r;return(r=i.actor)==null?void 0:r.applyDamage(a,{multiplier:t,invertHealing:!1,ignore:!0})}))}selectTargets(e,t){if(!(canvas!=null&&canvas.ready))return;const a=e.closest("[data-message-id]").querySelectorAll(`.evaluation li.target.${t}`),i=new Set(Array.from(a).map(r=>r.dataset.uuid));canvas.tokens.releaseAll(),i.forEach(r=>{var c;const n=fromUuidSync(r);if(!n)return;const l=n.isToken?[(c=n.token)==null?void 0:c.object]:n.getActiveTokens();for(const g of l)g!=null&&g.isVisible&&n.testUserPermission(game.user,"OWNER")&&g.control({releaseOthers:!1})})}applyChatCardTemp(e){const t=this.rolls.reduce((a,i)=>a+i.total,0);return Promise.all(canvas.tokens.controlled.map(a=>{var i;return(i=a.actor)==null?void 0:i.applyTempHP(t)}))}_onClickDiceRoll(e){e.stopPropagation(),e.currentTarget.classList.toggle("expanded")}static onRenderChatPopout(e,[t]){var i;const a=t.querySelector(".header-button.close");a.innerHTML='<i class="fas fa-times"></i>',a.dataset.tooltip=game.i18n.localize("Close"),a.setAttribute("aria-label",a.dataset.tooltip),(i=t.querySelector(".message-metadata [data-context-menu]"))==null||i.remove()}static onRenderChatLog([e]){game.settings.get("dnd5e","autoCollapseItemCards")||requestAnimationFrame(()=>{setTimeout(()=>ui.chat.scrollBottom(),250)})}static activateListeners(){window.addEventListener("keydown",this.toggleModifiers,{passive:!0}),window.addEventListener("keyup",this.toggleModifiers,{passive:!0}),window.addEventListener("blur",()=>this.toggleModifiers({releaseAll:!0}),{passive:!0})}static toggleModifiers({releaseAll:e=!1}={}){document.querySelectorAll(".chat-sidebar > ol").forEach(t=>{for(const a of Object.values(KeyboardManager.MODIFIER_KEYS))game.keyboard.isModifierActive(a)&&!e?t.dataset[`modifier${a}`]="":delete t.dataset[`modifier${a}`]})}_onDelete(e,t){super._onDelete(e,t),dnd5e.registry.messages.untrack(this)}getAssociatedActivity(){var t,a;const e=fromUuidSync(this.getFlag("dnd5e","activity.uuid"));return e||((a=(t=this.getAssociatedItem())==null?void 0:t.system.activities)==null?void 0:a.get(this.getFlag("dnd5e","activity.id")))}getAssociatedActor(){if(this.speaker.scene&&this.speaker.token){const e=game.scenes.get(this.speaker.scene),t=e==null?void 0:e.tokens.get(this.speaker.token);if(t)return t.actor}return game.actors.get(this.speaker.actor)}getAssociatedItem(){const e=fromUuidSync(this.getFlag("dnd5e","item.uuid"));if(e)return e;const t=this.getAssociatedActor();if(!t)return;const a=this.getFlag("dnd5e","item.data")??this.getOriginatingMessage().getFlag("dnd5e","item.data");if(a)return new Item.implementation(a,{parent:t})}getAssociatedRolls(e){return dnd5e.registry.messages.get(this.id,e)}getOriginatingMessage(){return game.messages.get(this.getFlag("dnd5e","originatingMessage"))??this}_shimFlags(){var t;const e=foundry.utils.getProperty(this,"flags.dnd5e");if((e==null?void 0:e.messageType)==="usage"&&(e!=null&&e.use)){const a="The item data in the `dnd5e.use` flag on `ChatMessage` is now `dnd5e.item.type`, `dnd5e.item.id`, and `dnd5e.item.uuid`. Checking for usage can now be done using the `dnd5e.messageType` flag.";Object.defineProperty(e.use,"type",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.type},configurable:!0,enumerable:!1}),Object.defineProperty(e.use,"itemId",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.id},configurable:!0,enumerable:!1}),Object.defineProperty(e.use,"itemUuid",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.uuid},configurable:!0,enumerable:!1})}else if((e==null?void 0:e.messageType)==="roll"&&(e!=null&&e.roll)){const a="The item data in the `dnd5e.roll` flag on `ChatMessage` is now `dnd5e.item.id` and `dnd5e.item.uuid`.";Object.defineProperty(e.roll,"itemId",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.id},configurable:!0,enumerable:!1}),Object.defineProperty(e.roll,"itemUuid",{get(){var i;return foundry.utils.logCompatibilityWarning(a,{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),(i=e.item)==null?void 0:i.uuid},configurable:!0,enumerable:!1})}(t=e==null?void 0:e.item)!=null&&t.data&&Object.defineProperty(e,"itemData",{get(){return foundry.utils.logCompatibilityWarning("The `dnd5e.itemData` flag on `ChatMessage` is now `dnd5e.item.data`.",{since:"DnD5e 4.0",until:"DnD5e 4.4",once:!0}),this.item.data},configurable:!0,enumerable:!1})}}const E=class E{static resetRollGetters(s){return s._total=s._evaluateTotal(),s.resetFormula(),s}static replaceTerms(s,e){return s.terms=e.terms,s._total=s._evaluateTotal(),s.resetFormula(),s}static getDialogSetting(s,e){var a;const t=_.get(de.skipRollConfig.tag);if(p.log("getDialogSetting",["skip mode: "+t,H.keysPressed,e]),((a=e.flags)==null?void 0:a["ddb-game-log"])!==void 0)return!1;switch(t){case 1:return H.keysPressed.indexOf("Shift")!=-1;default:return s}}};R(E,"streamlineDDBRoll",async(s,e,t,a,i)=>{let r=null;p.log("streamlineDDBRoll",[s,e,{...a},i]);let n={},l=a.rolls[0];n.dialog={configure:!0},n.roll={formula:l.formula,consume:{resources:!1,spellSlot:!1},rolls:[],flags:{...a.flags,[N]:{processed:!0},dnd5e:{...a.flags.dnd5e},rsr5e:{processed:!0,quickRoll:!1}}},a.flags=n.roll.flags,n.message={flavor:a.flavor,speaker:a.speaker,whisper:a.whisper,user:game.user,blind:a.blind||k.isPrivateRoll(i.rollMode),rollMode:i.rollMode};try{switch(!0){case s===T.toHit.cls:r=v.getActivityFromItem(e,s)??null,await E.triggerAttack(r,a,i,n);break;case s===T.damage.cls:r=v.getActivityFromItem(e,s)??null,await E.triggerDamage(r,a,i,n);break;case(s===T.save.cls||s===T.check.cls):r=null,await E.triggerAbilityTest(s,a,i,n);break;case s===T.heal.cls:r=v.getActivityFromItem(e,s)??null,await E.triggerHeal(r,a,i,n);break;case s===T.custom.cls:r=null,await E.triggerCustomRoll(n,a,t,i);break;default:p.log("streamlineDDBRoll",[s])}}catch(c){return p.error("Error intercepting DDB roll",[c,s,e,a,i]),!1}return!0}),R(E,"triggerAttack",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found.");a.roll.flags.rsr5e={processed:!0},a.roll.flags.dnd5e.targets=k.getTargetDescriptors(),a.roll.flags.dnd5e.roll={type:O.attack};let r=await s.rollAttack(a.roll,a.dialog,{create:!1});if(r.length<1)return;E.replaceTerms(r[0],e.rolls[0]);const n=s.metadata.usage.chatCard;s.metadata.usage.chatCard=`modules/${N}/templates/ddb-attack-info.hbs`,i=await v.ddbglUse(s,a.roll,a.dialog,{create:!1,data:{rollMsg:e.content,rolls:r,speaker:a.message.speaker,flavor:`<span class="crlngn item-name">${s.item.name}:</span> <span class="crlngn ${e.flags["ddb-game-log"].cls.replace(" ","")}">${e.flags["ddb-game-log"].cls}</span>`,flags:{rsr5e:a.roll.flags.rsr5e,[N]:{processed:!0,rollMode:t.rollMode,cls:e.flags["ddb-game-log"].cls,flavor:`<span class="crlngn item-name">${s.item.name}:</span> <span class="crlngn ${e.flags["ddb-game-log"].cls.replace(" ","")}">${e.flags["ddb-game-log"].cls}</span>`}}}}),i.message.rolls=r,i.message.flags.dnd5e.targets=k.getTargetDescriptors(),i.message.flags=i.message.flags??{},p.log("USAGE RESULTS",[i]),await ce.create(i.message,{rollMode:t.rollMode}),s.metadata.usage.chatCard=n}),R(E,"triggerDamage",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found.");s.attack||(i=await v.ddbglUse(s,a.roll,a.dialog,{create:!1}),await ce.create(i.message,{rollMode:t.rollMode}));let r=await s.rollDamage(a.roll,a.dialog,{create:!1});r.length<1||(E.replaceTerms(r[0],e.rolls[0]),i||(i={message:a.message}),i.message.rolls=r,i.message.flags=i.message.flags??{},i.message.flags.rsr5e={processed:!0,quickRoll:!1},a.roll.flags.dnd5e.targets=k.getTargetDescriptors(),a.roll.flags.dnd5e.roll={type:O.damage},a.message.flags=a.roll.flags,a.message.flags={...a.message,dnd5e:a.roll.flags.dnd5e,rsr5e:a.roll.flags.rsr5e},await r[0].toMessage(a.message,{rollMode:t.rollMode}),s.attack||game.user.targets.forEach(n=>{n.actor.testUserPermission(game.user,"OWNER")&&n.control({releaseOthers:!1})}),setTimeout(()=>{k.removeTemplateForItem(s.item)},3e3))}),R(E,"triggerAbilityTest",async(s,e,t,a)=>{const i=k.parseDDBGLAbility(e.flags["ddb-game-log"].flavor);let r;a.roll.flags.dnd5e.roll={type:s===T.check.cls?"ability":"save"},i&&(a.roll.flags.dnd5e.roll={type:s===T.check.cls?O.abilityCheck:O.abilitySave,ability:i.abbrev}),a.message.flags={...a.message,dnd5e:a.roll.flags.dnd5e,rsr5e:a.roll.flags.rsr5e},s===T.save.cls?r=await t.actor.rollSavingThrow({ability:i==null?void 0:i.abbrev},a.dialog,{create:!1}):s===T.check.cls&&(r=await t.actor.rollAbilityCheck({ability:i==null?void 0:i.abbrev},a.dialog,{create:!1}),p.log("triggerAbilityTest",[r,a.message])),!(r.length<1)&&(E.replaceTerms(r[0],e.rolls[0]),await r[0].toMessage(a.message,{rollMode:t.rollMode}))}),R(E,"triggerHeal",async(s,e,t,a)=>{let i;if(!s)throw new Error("No associated activity found.");i=await v.ddbglUse(s,a.roll,a.dialog,{create:!1}),p.log("ACTIVITY",[i]),await ce.create(i.message,{rollMode:t.rollMode});let r=await s.rollDamage(a.roll,a.dialog,{create:!1,data:{flags:a.message.flags}});r.length<1||(E.replaceTerms(r[0],e.rolls[0]),i||(i={message:a.message}),i.message.rolls=r,i.message.flags=i.message.flags??{},i.message.flags.rsr5e={processed:!0,quickRoll:!1},a.roll.flags.dnd5e.roll={type:O.healing},a.roll.flags.dnd5e.targets=k.getTargetDescriptors(),a.message.flags={...a.message,dnd5e:a.roll.flags.dnd5e,rsr5e:a.roll.flags.rsr5e},await r[0].toMessage(a.message,{rollMode:t.rollMode}))}),R(E,"triggerCustomRoll",async(s,e,t,a)=>{s.message={...s.message,dnd5e:{...s.roll.flags.dnd5e},rsr5e:s.roll.flags.rsr5e},await e.rolls[0].toMessage(s.message,{...a})});let ee=E;const D=class D{static init(){D.setupKeyListeners(),D.registerHooks()}static registerHooks(){Hooks.once(L.INIT,()=>{D.isMidiOn=k.isModuleOn("midi-qol"),p.log("Initiating module",[],!0),D.registerActivityHooks(),D.registerRollHooks(),D.registerChatHooks(),D.registerTemplateHooks()}),Hooks.once(L.READY,()=>{_.registerSettings(),_.resetGamelogSettings()}),Hooks.on(L.CLOSE_SETTINGS_CONFIG,()=>{_.resetGamelogSettings()})}static registerActivityHooks(){Hooks.on(C.PRE_USE_ACTIVITY,Je),Hooks.on(C.POST_USE_ACTIVITY,Qe)}static registerRollHooks(){Hooks.on(C.ROLL_ATTACK_V2,lt),Hooks.on(C.ROLL_DAMAGE_V2,nt),Hooks.on(C.PRE_ROLL_V2,st),Hooks.on(C.PRE_ROLL_ATTACK_V2,it),Hooks.on(C.PRE_ROLL_DAMAGE_V2,rt),Hooks.on(C.PRE_ROLL_SAVING_THROW,at)}static registerChatHooks(){Hooks.on(C.RENDER_CHAT_MESSAGE,tt),Hooks.on(L.PRE_CREATE_CHAT_MESSAGE,Ze),Hooks.on(L.CREATE_CHAT_MESSAGE,et)}static registerTemplateHooks(){Hooks.on(L.REFRESH_MEASURED_TEMPLATE,ot)}static setupKeyListeners(){window.addEventListener("keydown",s=>{const e=s.key;D.keysPressed.indexOf(e)<0&&D.keysPressed.push(e),p.log("Keydown",[D.keysPressed])}),window.addEventListener("keyup",s=>{const e=s.key,t=D.keysPressed.indexOf(e);t>=0&&D.keysPressed.splice(t,1),p.log("Keyup",[D.keysPressed])})}};R(D,"keysPressed",[]),R(D,"isMidiOn",!1);let H=D;const Je=async(o,s,e,t)=>(p.log(C.PRE_USE_ACTIVITY,[s,e,t,H.keysPressed]),!0),Qe=async(o,s,e)=>(p.log(C.POST_USE_ACTIVITY,[o,s,e]),!0),Ze=(o,s,e,t)=>{var m,d,u,y;let a=!1,i,r,n,l,c=!1;const g={...o};if(r=k.isModuleOn("ddb-game-log")&&((m=o.getFlag("ddb-game-log","cls"))==null?void 0:m.toLowerCase())||"",c=o.getFlag(N,"processed")||!1,p.log(L.PRE_CREATE_CHAT_MESSAGE,[r,o,{...s},e]),r&&!c)if(i=s.actor||game.actors.get(s.speaker.actor)||null,n=((u=(d=s.flags)==null?void 0:d["ddb-game-log"])==null?void 0:u.itemId)||"",i){a=!0,g.flags={...g.flags,...s.flags},g.flags[N]&&(g.flags[N].processed=!0,c=!0),l=n?i.items.find(b=>b.id===n):null;const h=document.createElement("div");h.innerHTML=s.flavor;let f=(y=h==null?void 0:h.querySelector("span:first-child"))==null?void 0:y.innerHTML.replace(":","");if(l||(l=f?i.items.find(b=>b.name.toLowerCase()===f.toLowerCase()):null,l||(l=i.items.find(b=>b.name.toLowerCase()===(f+" (Legacy)").toLowerCase()))),!l&&(r===T.toHit.cls||r===T.damage.cls||r===T.heal.cls))return p.error("Could not find an item for the roll",[r,i.items]),!0;ee.streamlineDDBRoll(r,l,f,g,s)}else return p.warn("Could not find the actor from DDB Gamelog roll"),!0;return!a||c},et=(o,s,e)=>{p.log(L.CREATE_CHAT_MESSAGE,[o,s,e])},tt=(o,s)=>{p.log(C.RENDER_CHAT_MESSAGE,[o,s]),he.enrichCard(o,s)},st=(o,s,e)=>{p.log(C.PRE_ROLL_V2,[o,s,e]),s.configure=ee.getDialogSetting(s.configure,o)},at=(o,s,e)=>{p.log(C.PRE_ROLL_SAVING_THROW,[o,s,e])},it=(o,s,e)=>(p.log(C.PRE_ROLL_ATTACK_V2,[e,s,o]),!0),rt=(o,s,e)=>(p.log(C.PRE_ROLL_DAMAGE_V2,[o,s,e,H.keysPressed]),!0),nt=(o,s,e)=>{p.log(C.ROLL_DAMAGE_V2,[game])},lt=async(o,s)=>{p.log(C.ROLL_ATTACK_V2,[o,s])},ot=(o,s)=>{var a;if(!o.isOwner)return;const e=_.get("template-auto-target");let t=3;switch(e){case 1:t=3;break;case 2:t=0;break;default:return}(a=canvas.tokens.placeables[0])==null||a.setTarget(!1,{releaseOthers:!0});for(let i of canvas.tokens.placeables)i.document.disposition<=t&&o.shape.contains(i.center.x-o.x,i.center.y-o.y)&&i.setTarget(!i.isTargeted,{releaseOthers:!1})};H.init();
//# sourceMappingURL=module.js.map
